{% extends "base/painel_principal.html" %}
{% block titulo %}{% endblock titulo %}

{% block css %}
<link rel="stylesheet" href="{{url_for('static',filename='css/calendario.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/modal_styles.css')}}">
<style>
  .disponivel{
    border-color: var(--color-success);
    border-width: 2px;
    background-color: rgba(40, 167, 69, 0.1);
  }
  .indisponivel{
    border-color: var(--color-danger);
    border-width: 2px;
    background-color: rgba(220, 53, 69, 0.1);
  }
  
  .dialog {
    z-index: 4 !important;
  }

  .dias {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    background: none;
    border: none;
    padding: 0;
    will-change: transform;
    transform: translateZ(0);
  }

  .dias:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.2);
  }

  .dias:active {
    transform: scale(0.95);
  }

  .dias:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .card {
    border: none;
    border-radius: 12px;
  }

  .card-header {
    border-radius: 12px 12px 0 0 !important;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  .calendar {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    will-change: transform;
    transform: translateZ(0); 
  }

  .events-container {
    min-height: 200px;
    height: 200px; 
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease-in-out;
    position: relative;
    overflow: hidden;
  }

  .events-container .card {
    width: 100%;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease-in-out;
    min-height: 200px; 
    display: flex;
    flex-direction: column;
  }

  .events-container .card .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .events-container > div {
    width: 100%;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .events-container .card-enter {
    opacity: 0;
    transform: translateY(10px);
  }

  .events-container .card-enter-active {
    opacity: 1;
    transform: translateY(0);
    transition: all 0.2s ease-in-out;
  }

  .events-container .card-exit {
    opacity: 1;
    transform: translateY(0);
  }

  .events-container .card-exit-active {
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.15s ease-in-out;
  }

  .events-container.loading {
    opacity: 0.7;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px; 
  }

  .events-container.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--color-primary);
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .events-container .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 200px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .table-date {
    will-change: transform;
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  .table-row {
    will-change: transform;
    transform: translateZ(0);
  }

  .tbody {
    will-change: transform;
    transform: translateZ(0);
  }

  .calendar-section {
    flex: 0 0 40%;
    max-width: 40%;
    padding: 0 15px;
  }

  .plantao-section {
    flex: 0 0 35%;
    max-width: 35%;
    padding: 0 15px;
  }

  .sidebar-section {
    flex: 0 0 25%;
    max-width: 25%;
    padding: 0 15px;
  }

  .cards-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }

  .plantao-card,
  .users-card {
    flex: 1;
    min-width: 200px;
  }

  .plantao-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  .plantao-shift-button {
    border: 2px solid var(--color-primary);
    border-radius: 12px;
    min-width: 120px;
    height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    color: var(--color-text);
    background-color: var(--color-white);
    transition: all 0.3s ease;
    cursor: pointer;
    padding: 12px 16px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .plantao-shift-button:hover {
    background-color: var(--color-primary-light);
    color: var(--color-white);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .plantao-shift-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .plantao-shift-button .shift-number {
    font-weight: bold;
    font-size: 20px;
    line-height: 1;
    margin-bottom: 4px;
  }

  .plantao-shift-button .shift-label {
    font-size: 12px;
    opacity: 0.9;
    line-height: 1;
  }

  .plantao-shift-button.numero_plantao_a_marcar {
    background-color: var(--color-primary);
    color: var(--color-white);
    border-color: var(--color-primary-dark);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  }

  /* Responsive design */
  @media (max-width: 576px) {
    .plantao-buttons {
      gap: 15px;
    }
    
    .plantao-shift-button {
      min-width: 100px;
      height: 70px;
      font-size: 14px;
    }
    
    .plantao-shift-button .shift-number {
      font-size: 18px;
    }
    
    .plantao-shift-button .shift-label {
      font-size: 11px;
    }
  }

  @media (max-width: 768px) {
    .calendar-section,
    .plantao-section,
    .sidebar-section {
      flex: 0 0 100%;
      max-width: 100%;
    }

    .cards-container {
      flex-direction: column;
    }

    .plantao-card,
    .users-card {
      flex: none;
      min-width: auto;
    }

    .dias {
      width: 60px;
      height: 60px;
      font-size: 18px;
    }
    
    .card-body {
      padding: 1rem;
    }

    .calendar {
      margin: 0;
    }

    .events-container {
      min-height: 150px;
    }

    .card-header h5 {
      font-size: 1rem;
    }

    .card-header small {
      font-size: 0.75rem;
    }
  }

  @media (max-width: 576px) {
    .dias {
      width: 50px;
      height: 50px;
      font-size: 16px;
    }

    .dias small {
      font-size: 0.7rem;
    }

    .card-body {
      padding: 0.75rem;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8rem;
    }
  }

  .icon.text-primary {
    background-color: var(--color-primary);
  }
  
  .icon.text-muted {
    background-color: var(--color-text-muted);
  }
  
  .icon.text-white {
    background-color: var(--color-white);
  }
  
  .icon.text-warning {
    background-color: var(--color-warning);
  }
  
  .icon.text-info {
    background-color: var(--color-info);
  }

  .card-header.bg-primary {
    background-color: var(--color-primary);
    color: var(--color-white);
  }
  
  .card-header.bg-primary h4,
  .card-header.bg-primary small {
    color: var(--color-white);
  }

  .left-button, .right-button {
    background: var(--color-primary);
    border: none;
    color: var(--color-white);
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .left-button:hover, .right-button:hover {
    background: var(--color-primary-dark);
    transform: scale(1.05);
  }

  .left-button:active, .right-button:active {
    transform: scale(0.95);
  }

  .year-header {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 40px;
  }

  .year-header .year {
    font-size: 20px;
    font-weight: bold;
    color: var(--color-white);
  }

</style>
{% endblock css %}

{% block conteudo %}
<input type="hidden" id="hdnAjaxEscala" value="{{url_for('plantao.ajax_obter_escala_plantao')}}">

<header class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="icon icon-calendar-alt mr-3 text-white" style="font-size: 1.5rem;"></i>
            <div>
              <h4 class="mb-0">Escala do Plantão</h4>
              <small class="opacity-75">Funcionário: {{ current_user.nome }}</small>
            </div>
          </div>
          <div class="d-flex">
            <button class="btn btn-outline-white mr-2" id="confirmar_editar_plantao" data-modal="confirmacaoEdicao">
              <i class="icon icon-edit mr-1 text-white"></i>Editar
            </button>
            {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value] %}
              <a class="btn btn-outline-white" href="{{url_for('plantao.configurar_abertura')}}">
                <i class="icon icon-cog mr-1 text-white"></i>Configurar Abertura
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="row">
  <section class="calendar-section">
    <article class="card shadow-sm h-100">
      <header class="card-header bg-light">
        <h5 class="card-title mb-0 d-flex align-items-center">
          <i class="icon icon-calendar mr-2 text-primary"></i>
          Calendário de Plantões
        </h5>
      </header>
      <div class="card-body d-flex justify-content-center p-3">
        <div class="calendar"> 
          <div class="year-header"> 
             <button class="left-button" id="prev" aria-label="Mês anterior"> <i class="icon icon-chevron-left text-white"></i> </button> 
              <span class="year" id="label"></span> 
              <button class="right-button" id="next" aria-label="Próximo mês"> <i class="icon icon-chevron-right text-white"></i> </button>
          </div> 
          <table class="months-table" role="grid"> 
            <tbody>
              <tr class="months-row">
                <td class="month" id="month1" role="gridcell" tabindex="0" aria-label="Janeiro">Jan</td>
                <td class="month" id="month2" role="gridcell" tabindex="0" aria-label="Fevereiro">Fev</td>
                <td class="month" id="month3" role="gridcell" tabindex="0" aria-label="Março">Mar</td>
                <td class="month" id="month4" role="gridcell" tabindex="0" aria-label="Abril">Abr</td>
                <td class="month" id="month5" role="gridcell" tabindex="0" aria-label="Maio">Mai</td>
                <td class="month" id="month6" role="gridcell" tabindex="0" aria-label="Junho">Jun</td>
                <td class="month" id="month7" role="gridcell" tabindex="0" aria-label="Julho">Jul</td>
                <td class="month" id="month8" role="gridcell" tabindex="0" aria-label="Agosto">Ago</td>
                <td class="month" id="month9" role="gridcell" tabindex="0" aria-label="Setembro">Set</td>
                <td class="month" id="month10" role="gridcell" tabindex="0" aria-label="Outubro">Out</td>
                <td class="month" id="month11" role="gridcell" tabindex="0" aria-label="Novembro">Nov</td>
                <td class="month" id="month12" role="gridcell" tabindex="0" aria-label="Dezembro">Dez</td>
              </tr>
            </tbody>
          </table>
            
          <table class="days-table" role="grid"> 
            <td class="day">D</td> 
            <td class="day">S</td> 
            <td class="day">T</td> 
            <td class="day">Q</td> 
            <td class="day">Q</td> 
            <td class="day">S</td> 
            <td class="day">S</td>
          </table> 
          <div class="frame"> 
            <table class="dates-table" role="grid"> 
                <tbody class="tbody">
                </tbody> 
            </table>
          </div> 
          <div class="d-flex justify-content-center mt-3">
             <button class="btn btn-primary" id="escolhe_data" data-modal="confirmacao">
               <i class="icon icon-check mr-1"></i>Selecionar data
             </button>
          </div>
        </div>
      </div>
    </article>
  </section>

  <section class="plantao-section">
    <div class="cards-container">
      <article class="card shadow-sm plantao-card">
        <header class="card-header bg-light">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="icon icon-clock mr-2 text-primary"></i>
            Seleção do Plantão
          </h5>
        </header>
        <div class="card-body">
          <div class="plantao-buttons">
            <button class="plantao-shift-button" id="numero_plantao_1" aria-label="Selecionar primeiro turno">
              <span class="shift-number">1°</span>
              <span class="shift-label">Turno</span>
            </button>
            {% if current_user.urole != UserRole.ORIENTADOR.value %}
              <button class="plantao-shift-button" id="numero_plantao_2" aria-label="Selecionar segundo turno">
                <span class="shift-number">2°</span>
                <span class="shift-label">Turno</span>
              </button>
            {% endif %}
          </div>
          <div class="text-center mt-3">
            <small class="text-muted">Clique para selecionar o turno do plantão</small>
          </div>
        </div>
      </article>

      <article class="card shadow-sm users-card">
        <header class="card-header bg-light">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="icon icon-user mr-2 text-primary"></i>
            Usuários Escalados
          </h5>
        </header>
        <div class="card-body events-container p-3">
          <div class="text-center text-muted empty-state">
            <i class="icon icon-calendar-plus mb-2 text-muted" style="font-size: 2rem;"></i>
            <p>Selecione uma data para ver os usuários escalados</p>
          </div>
        </div>
      </article>
    </div>
  </section>

  <aside class="sidebar-section">
    <article class="card shadow-sm mb-3">
      <header class="card-header bg-light">
        <h5 class="card-title mb-0 d-flex align-items-center">
          <i class="icon icon-calendar-check mr-2 text-primary"></i>
          Meus Plantões
        </h5>
      </header>
      <div class="card-body p-3" id="dias_plantao">
        {% include 'plantao/componentes/lista_datas_plantao.html' %}
      </div>
    </article>

    <article class="card shadow-sm">
      <header class="card-header bg-light">
        <h5 class="card-title mb-0 d-flex align-items-center">
          <i class="icon icon-cog mr-2 text-primary"></i>
          Configurações
        </h5>
      </header>
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <input type="checkbox" id="lembreteCheck" checked class="mr-2">
          <label for="lembreteCheck" class="mb-0">
            <i class="icon icon-bell mr-1 text-primary"></i>
            Lembrete no dia anterior
          </label>
        </div>
        <small class="text-muted d-block mt-2">
          <i class="icon icon-info-circle mr-1 text-muted"></i>
          Receba notificações 24h antes do plantão
        </small>
      </div>
    </article>
  </aside>
</main>
{% endblock conteudo %}

{%block modal %}
<div class="modal-overlay modal-hidden" 
     id="confirmacao" 
     role="dialog" 
     aria-modal="true" 
     aria-labelledby="confirmacao_title"
     aria-describedby="confirmacao_body">
  <div class="modal-content modal-md" tabindex="-1">
    <div class="modal-header">
      <h2 class="modal-title" id="confirmacao_title">Deseja confirmar o plantão?</h2>
      <button type="button" class="modal-close" data-modal-close="confirmacao" aria-label="Fechar modal">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body" id="confirmacao_body">
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-modal-close="confirmacao">Cancelar</button>
      <button type="button" class="btn btn-primary" id="id_botao_confirmar_modal">Confirmar</button>
    </div>
  </div>
</div>

<div class="modal-overlay modal-hidden" 
     id="confirmacaoEdicao" 
     role="dialog" 
     aria-modal="true" 
     aria-labelledby="confirmacaoEdicao_title"
     aria-describedby="confirmacaoEdicao_body">
  <div class="modal-content modal-md" tabindex="-1">
    <div class="modal-header">
      <h2 class="modal-title" id="confirmacaoEdicao_title">Esta ação irá apagar seu registro de plantão para que ele possa ser feito novamente. Deseja continuar?</h2>
      <button type="button" class="modal-close" data-modal-close="confirmacaoEdicao" aria-label="Fechar modal">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body" id="confirmacaoEdicao_body">
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-modal-close="confirmacaoEdicao">Cancelar</button>
      <button type="button" class="btn btn-primary" id="botao_confirmar_editar_plantao_modal">Confirmar</button>
    </div>
  </div>
</div>
{% endblock modal %}

{% block scripts %}

<script src="{{url_for('static',filename='js/base-utils.js')}}"></script>

<script>
  class CalendarState {
    constructor() {
      this.events = [];
      this.selectedDate = null;
      this.selectedMonth = new Date().getMonth();
      this.selectedYear = new Date().getFullYear();
      this.selectedShift = '1';
      this.lastSelectedDate = null;
      this.lastVagasData = null; 
    }

    setEvents(events) {
      this.events = events;
    }

    setSelectedDate(date) {
      this.selectedDate = date;
    }

    setSelectedMonth(month) {
      this.selectedMonth = month;
    }

    setSelectedYear(year) {
      this.selectedYear = year;
    }

    setSelectedShift(shift) {
      this.selectedShift = shift;
    }

    getEventsForDate(day, month, year) {
      return this.events.filter(event => 
        event.day === day && event.month === month && event.year === year
      );
    }
  }

  const calendarState = new CalendarState();

  function updateSelectedShift(shiftNumber) {
    document.querySelectorAll('.numero_plantao_a_marcar').forEach(el => {
      el.classList.remove('numero_plantao_a_marcar');
    });
    
    const shiftButton = document.getElementById(`numero_plantao_${shiftNumber}`);
    if (shiftButton) {
      shiftButton.classList.add('numero_plantao_a_marcar');
    }
    
    calendarState.setSelectedShift(shiftNumber);
  }

  const domCache = {
    yearElement: null,
    eventsContainer: null,
    tbody: null,
    activeDate: null,
    activeMonth: null
  };

  function initializeDOMCache() {
    domCache.yearElement = document.querySelector('.year');
    domCache.eventsContainer = document.querySelector('.events-container');
    domCache.tbody = document.querySelector('.tbody');
  }

  function setupEventDelegation() {
    document.addEventListener('click', (e) => {
      if (e.target.matches('#numero_plantao_1, #numero_plantao_2')) {
        const shiftNumber = e.target.id.split('_').pop();
        updateSelectedShift(shiftNumber);
        return;
      }
      
      if (e.target.matches('.table-date:not(.nil)')) {
        handleDateClick(e.target);
        return;
      }
      
      if (e.target.matches('.month')) {
        handleMonthClick(e.target);
        return;
      }
      
      if (e.target.matches('#prev, .left-button, .left-button i')) {
        handleYearChange(-1);
        return;
      }
      
      if (e.target.matches('#next, .right-button, .right-button i')) {
        handleYearChange(1);
        return;
      }
    });
  }

  function handleDateClick(target) {
    const day = parseInt(target.textContent);
    const month = calendarState.selectedMonth + 1;
    const year = calendarState.selectedYear;
    const dateKey = `${day}-${month}-${year}`;
    
    if (calendarState.lastSelectedDate === dateKey) {
      return; 
    }
    
    const events = calendarState.getEventsForDate(day, month, year);
    
    if (domCache.activeDate) {
      domCache.activeDate.classList.remove('active-date');
    }
    target.classList.add('active-date');
    domCache.activeDate = target;
    
    calendarState.setSelectedDate(day);
    calendarState.lastSelectedDate = dateKey; 
    
    showEvents(events, monthsArray[calendarState.selectedMonth], day);
    
    debounce(() => {
      vagasDisponiveis();
    }, 100)();
  }

  function handleMonthClick(target) {
    const monthIndex = Array.from(target.parentElement.children).indexOf(target);
    const date = new Date(calendarState.selectedYear, monthIndex);
    
    if (domCache.activeMonth) {
      domCache.activeMonth.classList.remove('active-month');
    }
    target.classList.add('active-month');
    domCache.activeMonth = target;
    
    calendarState.setSelectedMonth(monthIndex);
    calendarState.lastSelectedDate = null; 
    date.setMonth(monthIndex);
    initCalendar(date);
    
    debounce(() => {
      coloreCalendario();
      vagasDisponiveis();
    }, 100)();
  }

  function handleYearChange(direction) {
    const newYear = calendarState.selectedYear + direction;
    calendarState.setSelectedYear(newYear);
    calendarState.lastSelectedDate = null; 
    
    if (domCache.yearElement) {
      domCache.yearElement.textContent = newYear;
    }
    
    const date = new Date(newYear, calendarState.selectedMonth);
    initCalendar(date);
    
    debounce(() => {
      coloreCalendario();
      vagasDisponiveis();
    }, 100)();
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  document.addEventListener('DOMContentLoaded', function() {
    initializeDOMCache();
    updateSelectedShift('{{numero_plantao}}');
    setupEventDelegation();
    initializeCalendar();

    document.addEventListener('click', function(e) {
      if (e.target.hasAttribute('data-modal')) {
        const modalId = e.target.getAttribute('data-modal');
        if (window.ModalManager && typeof window.ModalManager.open === 'function') {
          window.ModalManager.open(modalId);
        } else {
          console.error('ModalManager is not available');
        }
      }
      
      if (e.target.hasAttribute('data-modal-close')) {
        const modalId = e.target.getAttribute('data-modal-close');
        if (window.ModalManager && typeof window.ModalManager.close === 'function') {
          window.ModalManager.close(modalId);
        } else {
          console.error('ModalManager is not available');
        }
      }
    });
  });

  function initializeCalendar() {
    const ajaxUrl = document.getElementById('hdnAjaxEscala').value;
    
    fetch(window.origin + ajaxUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json;charset=UTF-8'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      calendarState.setEvents(result);
      
      const date = new Date();
      const today = date.getDate();
      
      const monthsRow = document.querySelector('.months-row');
      if (monthsRow && monthsRow.children[date.getMonth()]) {
        monthsRow.children[date.getMonth()].classList.add('active-month');
        domCache.activeMonth = monthsRow.children[date.getMonth()];
      }

      initCalendar(date);
      const eventos_dia = calendarState.getEventsForDate(today, date.getMonth()+1, date.getFullYear());
      showEvents(eventos_dia, monthsArray[date.getMonth()], today);
      
      debounce(() => {
        vagasDisponiveis();
        coloreCalendario();
      }, 100)();
    })
    .catch(error => {
      console.error('Error loading calendar data:', error);
      alert('Erro ao carregar dados do calendário');
    });
  }

  function initCalendar(date) {
    if (!domCache.tbody) return;
    
    const fragment = document.createDocumentFragment();
    const eventsContainer = domCache.eventsContainer;
    
    domCache.tbody.innerHTML = '';
    if (eventsContainer) eventsContainer.innerHTML = '';
    
    const month = date.getMonth();
    const year = date.getFullYear();
    const dayCount = daysInMonth(month, year);
    const today = date.getDate();
    
    date.setDate(1);
    const firstDay = date.getDay();
    
    let row = document.createElement('tr');
    row.className = 'table-row';
    
    for(let i = 0; i < 35 + firstDay; i++) {
      const day = i - firstDay + 1;
      
      if(i % 7 === 0) {
        fragment.appendChild(row);
        row = document.createElement('tr');
        row.className = 'table-row';
      }
      
      if(i < firstDay || day > dayCount) {
        const currDate = document.createElement('td');
        currDate.className = 'table-date nil';
        row.appendChild(currDate);
      } else {
        const currDate = document.createElement('td');
        currDate.className = 'table-date';
        currDate.textContent = day;
        
        const events = calendarState.getEventsForDate(day, month + 1, year);
        if(today === day && !domCache.activeDate) {
          currDate.classList.add('active-date');
          domCache.activeDate = currDate;
          showEvents(events, monthsArray[month], day);
        }
        
        row.appendChild(currDate);
      }
    }
    
    fragment.appendChild(row);
    domCache.tbody.appendChild(fragment);
    
    if (domCache.yearElement) {
      domCache.yearElement.textContent = year;
    }
  }

  function daysInMonth(month, year) {
    const monthStart = new Date(year, month, 1);
    const monthEnd = new Date(year, month + 1, 1);
    return (monthEnd - monthStart) / (1000 * 60 * 60 * 24);
  }


  function createEventCard(events, month, day) {
    const template = document.createElement('template');
    
    if (events.length === 0) {
      template.innerHTML = `
        <div class="text-center text-muted empty-state">
          <i class="icon icon-exclamation-triangle text-warning mb-3" style="font-size: 2rem;"></i>
          <h6 class="text-warning">Nenhum usuário escalado</h6>
          <p class="text-muted mb-0">Não há escalados para ${day} de ${month}.</p>
        </div>
      `;
    } else {
      const eventsList = events.map((event, index) => `
        <div class="d-flex align-items-center p-2 mb-2 bg-light rounded">
          <div class="me-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; font-size: 14px; font-weight: bold;">
              ${index + 1}
            </div>
          </div>
          <div class="flex-grow-1">
            <h6 class="mb-0 text-primary">${event.nome}</h6>
            <small class="text-muted">Usuário escalado</small>
          </div>
        </div>
      `).join('');
      
      template.innerHTML = `
        <div class="w-100">
          <div class="bg-primary text-white text-center p-3 mb-3 rounded">
            <h6 class="mb-0">
              <i class="icon icon-user me-2 text-white"></i>
              Usuários Escalados - ${day}/${month}
            </h6>
          </div>
          <div class="p-3">
            ${eventsList}
          </div>
        </div>
      `;
    }
    
    return template.content.firstElementChild;
  }

  function showEvents(events, month, day) {
    if (!domCache.eventsContainer) return;
    
    const newEventCard = createEventCard(events, month, day);
    const newContent = newEventCard.innerHTML;
    
    const existingContent = domCache.eventsContainer.firstElementChild;
    const existingContentHTML = existingContent ? existingContent.innerHTML : '';
    
    if (newContent === existingContentHTML) {
      return;
    }
    
    domCache.eventsContainer.classList.add('loading');
    
    requestAnimationFrame(() => {
      if (existingContent) {
        existingContent.classList.add('card-exit');
        
        setTimeout(() => {
          domCache.eventsContainer.replaceChildren();
          domCache.eventsContainer.style.display = 'flex';
          domCache.eventsContainer.style.alignItems = 'center';
          domCache.eventsContainer.style.justifyContent = 'center';
          
          const eventCard = createEventCard(events, month, day);
          eventCard.classList.add('card-enter');
          domCache.eventsContainer.appendChild(eventCard);
          
          domCache.eventsContainer.classList.remove('loading');
          
          requestAnimationFrame(() => {
            eventCard.classList.remove('card-enter');
            eventCard.classList.add('card-enter-active');
          });
        }, 150);
      } else {
        domCache.eventsContainer.replaceChildren();
        domCache.eventsContainer.style.display = 'flex';
        domCache.eventsContainer.style.alignItems = 'center';
        domCache.eventsContainer.style.justifyContent = 'center';
        
        const eventCard = createEventCard(events, month, day);
        eventCard.classList.add('card-enter');
        domCache.eventsContainer.appendChild(eventCard);
        
        domCache.eventsContainer.classList.remove('loading');
        
        requestAnimationFrame(() => {
          eventCard.classList.remove('card-enter');
          eventCard.classList.add('card-enter-active');
        });
      }
    });
  }


  const monthsArray = [
    "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
  ];

  function vagasDisponiveis() {
    if (!domCache.yearElement || !domCache.activeMonth || !domCache.activeDate) return;
    
    const ano = domCache.yearElement.textContent;
    const mes = domCache.activeMonth.id.substring(5);
    const dia = domCache.activeDate.textContent;
    
    const url = new URL("{{url_for('plantao.ajax_vagas_disponiveis')}}", window.location.origin);
    url.searchParams.append('ano', ano);
    url.searchParams.append('mes', mes);
    url.searchParams.append('dia', dia);
    
    fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json;charset=UTF-8'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      if (!domCache.eventsContainer) return;
      
      const newVagasContent = `
        <div class="d-flex align-items-center">
          <i class="icon icon-info-circle text-info me-2"></i>
          <span class="fw-bold text-info">Vagas disponíveis: ${result.NumeroVagas}</span>
        </div>
      `;
      
      const existingVagas = domCache.eventsContainer.querySelector('.vagas-info');
      const existingVagasContent = existingVagas ? existingVagas.innerHTML : '';
      
      if (newVagasContent === existingVagasContent) {
        return;
      }
      
      requestAnimationFrame(() => {
        if (existingVagas) {
          existingVagas.style.opacity = '0';
          existingVagas.style.transform = 'translateY(-5px)';
          
          setTimeout(() => {
            existingVagas.remove();
          }, 150);
        }
        
        const vagasInfo = document.createElement('div');
        vagasInfo.className = 'vagas-info mt-3 p-3 bg-info bg-opacity-10 border border-info rounded';
        vagasInfo.style.opacity = '0';
        vagasInfo.style.transform = 'translateY(5px)';
        vagasInfo.style.transition = 'all 0.2s ease-in-out';
        vagasInfo.innerHTML = newVagasContent;
        
        const existingContent = domCache.eventsContainer.firstElementChild;
        if (existingContent) {
          existingContent.appendChild(vagasInfo);
        } else {
          domCache.eventsContainer.appendChild(vagasInfo);
        }
        
        requestAnimationFrame(() => {
          vagasInfo.style.opacity = '1';
          vagasInfo.style.transform = 'translateY(0)';
        });
      });
    })
    .catch(error => {
      console.error('Error loading available slots:', error);
    });
  }

  function coloreCalendario() {
    if (!domCache.yearElement || !domCache.activeMonth) return;
    
    const ano = domCache.yearElement.textContent;
    const mes = domCache.activeMonth.id.substring(5);
    
    const url = new URL("{{url_for('plantao.ajax_disponibilidade_de_vagas')}}", window.location.origin);
    url.searchParams.append('ano', ano);
    url.searchParams.append('mes', mes);
    
    fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json;charset=UTF-8'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      const elementos = domCache.tbody?.querySelectorAll('.table-date:not(.nil)') || [];
      const elementosNulos = domCache.tbody?.querySelectorAll('.nil') || [];
      
      const fragment = document.createDocumentFragment();
      
      elementos.forEach(el => {
        el.classList.remove('disponivel', 'indisponivel');
      });
      
      result.forEach(item => {
        elementos.forEach(el => {
          if (el.textContent == item.Dia) {
            if (item.Vagas === true) {
              el.classList.add('disponivel');
            } else {
              el.classList.add('indisponivel');
            }
          }
        });
      });
      
      elementosNulos.forEach(el => {
        el.classList.remove('disponivel', 'indisponivel');
      });
    })
    .catch(error => {
      console.error('Error loading availability:', error);
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const escolheDataBtn = document.getElementById('escolhe_data');
    if (escolheDataBtn) {
      escolheDataBtn.addEventListener('click', function() {
        coloreCalendario();
        if (domCache.yearElement && domCache.activeMonth && domCache.activeDate) {
          const ano = domCache.yearElement.textContent;
          const mes = domCache.activeMonth.id.substring(5);
          const dia = domCache.activeDate.textContent;
          
          const modalBody = document.getElementById('id_body_modal');
          if (modalBody) {
            modalBody.innerHTML = `Data selecionada: ${dia}/${mes}/${ano}`;
          }
        }
      });
    }

    const confirmBtn = document.getElementById('id_botao_confirmar_modal');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        if (!domCache.yearElement || !domCache.activeMonth || !domCache.activeDate) return;
        
        const ano = domCache.yearElement.textContent;
        const mes = domCache.activeMonth.id.substring(5);
        const dia = domCache.activeDate.textContent;
        
        const url = new URL("{{url_for('plantao.ajax_confirma_data_plantao')}}", window.location.origin);
        url.searchParams.append('ano', ano);
        url.searchParams.append('mes', mes);
        url.searchParams.append('dia', dia);
        
        fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json;charset=UTF-8'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(result => {
          const diasPlantao = document.getElementById('dias_plantao');
          if (diasPlantao) {
            diasPlantao.innerHTML = result.lista_datas;
          }
          
          atualiza_numero_plantao_a_marcar(String(result.numero_plantao));
          
          if (window.ModalManager && typeof window.ModalManager.close === 'function') {
            window.ModalManager.close('confirmacao');
          }
          
          switch(result.tipo_mensagem) {
            case 'success':
              if (typeof showNotification === 'function') {
                showNotification('Sucesso!', result.mensagem, 'success');
              } else {
                alert('Sucesso! ' + result.mensagem);
              }
              break;
            case 'warning':
              if (typeof showNotification === 'function') {
                showNotification('Atenção:', result.mensagem, 'warning');
              } else {
                alert('Atenção: ' + result.mensagem);
              }
              break;
          }
        })
        .catch(error => {
          console.error('Error confirming plantão:', error);
          if (typeof showNotification === 'function') {
            showNotification('Erro!', 'Erro ao confirmar plantão', 'danger');
          } else {
            alert('Erro ao confirmar plantão');
          }
        });
      });
    }

    const editBtn = document.getElementById('botao_confirmar_editar_plantao_modal');
    if (editBtn) {
      editBtn.addEventListener('click', function() {
        if (window.ModalManager && typeof window.ModalManager.close === 'function') {
          window.ModalManager.close('confirmacaoEdicao');
        }
        window.location.href = "{{url_for('plantao.editar_plantao')}}";
      });
    }
  });
</script>

{% endblock scripts %}