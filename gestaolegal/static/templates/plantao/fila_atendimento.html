{% extends "base/painel_principal.html" %}

{% block css %}
<link rel="stylesheet" href="{{url_for('static',filename='css/table_styles.css')}}">
<style>
    .legends-container {
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-end;
    }

    .legends {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: center;
        justify-content: flex-end;
        gap: 1.5rem;
        background-color: var(--color-background-muted);
        padding: 12px 16px;
        border-radius: 6px;
        border: 1px solid var(--color-border);
    }

    .legends > div {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 12px;
    }

    .legends span.badge:empty {
        display: inline-block;
        width: 20px;
        height: 8px;
        border-radius: 0 !important;
    }

    .legends span.bg-warning:empty {
        background-color: var(--color-warning) !important;
    }

    .legends span.bg-primary:empty {
        background-color: var(--color-primary) !important;
    }

    .legends span.bg-white:empty {
        height: 6px;
        border: 1px solid var(--color-border);
    }

    .toggle-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border: 1px solid var(--color-primary);
        background-color: transparent;
        color: var(--color-primary);
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .toggle-button:hover {
        background-color: var(--color-primary);
        color: var(--color-white);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-button:active {
        transform: translateY(0);
    }

    .toggle-icon {
        transition: transform 0.2s ease;
        font-size: 14px;
    }

    .toggle-button[aria-expanded="true"] .toggle-icon {
        transform: rotate(180deg);
    }

    /* Completed Section Styling */
    .completed-section {
        margin-top: 24px;
        border-top: 2px solid var(--color-border);
        padding-top: 24px;
        animation: slideDown 0.3s ease-out;
    }

    .completed-section.hidden {
        display: none !important;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block page_title %} Fila de Atendimento {% endblock %}
{% block titulo %}
    <div class="page-header">
        <h1>Fila de Atendimento</h1>
        <div class="action-section">
            <button id="outQueue" type="button" class="btn btn-outline-primary btn-sm toggle-button" 
                aria-expanded="false" aria-controls="completed-section">
                <span class="toggle-text">Mostrar atendidos/cancelados</span>
                <i class="fas fa-angle-down toggle-icon"></i>
            </button>
        </div>
    </div>
{% endblock %}



{% block conteudo %}
<div class="page-container">
    <div class="legends-container">
        <div class="legends">
            <div>
                <span class="badge bg-warning"></span>
                <span>Super Prioridade</span>
            </div>
            <div>
                <span class="badge bg-primary"></span>
                <span>Prioridade</span>
            </div>
            <div>
                <span class="badge bg-white"></span>
                <span>Normal</span>
            </div>
        </div>
    </div>
    
    <div class="table-container">
        <table class="results-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nome</th>
                    <th>Senha</th>
                    <th>Hora</th>
                    <th>Psicologia</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="main-queue"></tbody>
        </table>
    </div>

    <div id="completed-section" class="completed-section" style="display: none;">
        <div class="page-container">
            <div class="page-header">
                <h2>Atendidos e Cancelados</h2>
            </div>
            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome</th>
                            <th>Senha</th>
                            <th>Hora</th>
                            <th>Psicologia</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="completed-queue"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script defer>
    let options = {
        year: "numeric",
        month: "numeric",
        day: "numeric",
    };
    const atendidos = [];
    const mainQueue = document.querySelector("#main-queue");
    const completedQueue = document.querySelector("#completed-queue");
    
    const todosAtendidos = async () => {
        let res = await fetch("{{url_for('plantao.pegar_atendimentos')}}", {
            headers: {
                'X-CSRF-Token': "{{ csrf_token() }}",
                'Content-Type': 'application/json'
            }
        });
        let data = await res.json();
        data.map(item => atendidos.push(item));

        // Montar fila de atendimento (apenas status 0 - na fila)
        let superPrioridade = filtrarPrioridade(2).filter(item => item.status === 0);
        let prioridade = filtrarPrioridade(1).filter(item => item.status === 0);
        let normal = filtrarPrioridade(0).filter(item => item.status === 0);
        
        montarTabela(superPrioridade, mainQueue);
        montarTabela(prioridade, mainQueue);
        montarTabela(normal, mainQueue);

        // Montar fila de atendidos/cancelados (status 1 e 2)
        let superPrioridadeCompletos = filtrarPrioridade(2).filter(item => item.status !== 0);
        let prioridadeCompletos = filtrarPrioridade(1).filter(item => item.status !== 0);
        let normalCompletos = filtrarPrioridade(0).filter(item => item.status !== 0);
        
        montarTabelaChamados(superPrioridadeCompletos, completedQueue);
        montarTabelaChamados(prioridadeCompletos, completedQueue);
        montarTabelaChamados(normalCompletos, completedQueue);

        // Event listener para toggle
        document.querySelector("#outQueue").addEventListener("click", (e) => {
            const button = e.currentTarget;
            const completedSection = document.querySelector("#completed-section");
            const toggleText = button.querySelector(".toggle-text");
            const toggleIcon = button.querySelector(".toggle-icon");
            const isExpanded = button.getAttribute("aria-expanded") === "true";
            
            if (isExpanded) {
                // Hide section
                completedSection.style.display = "none";
                completedSection.classList.add("hidden");
                toggleText.textContent = "Mostrar atendidos/cancelados";
                toggleIcon.className = "fas fa-angle-down toggle-icon";
                button.setAttribute("aria-expanded", "false");
            } else {
                // Show section
                completedSection.style.display = "block";
                completedSection.classList.remove("hidden");
                toggleText.textContent = "Ocultar atendidos/cancelados";
                toggleIcon.className = "fas fa-angle-up toggle-icon";
                button.setAttribute("aria-expanded", "true");
            }
        })
    }
    const buttonsActions = async (button, act) => {
        let atendido = atendidos.filter(item => item.id === parseInt(button.dataset.id))
        atendido[0].status = act;
        let res = await fetch("{{url_for('plantao.pegar_atendimentos')}}", {
            method: "PUT",
            headers: {
                'X-CSRF-Token': "{{ csrf_token() }}",
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({id: atendido[0].id, status: act})
        })
        
        // Limpar as tabelas
        mainQueue.innerHTML = "";
        completedQueue.innerHTML = "";

        // Remontar as tabelas
        let superPrioridade = filtrarPrioridade(2);
        let prioridade = filtrarPrioridade(1);
        let normal = filtrarPrioridade(0);
        
        // Fila principal (apenas status 0)
        let superPrioridadeFila = superPrioridade.filter(item => item.status === 0);
        let prioridadeFila = prioridade.filter(item => item.status === 0);
        let normalFila = normal.filter(item => item.status === 0);
        
        montarTabela(superPrioridadeFila, mainQueue);
        montarTabela(prioridadeFila, mainQueue);
        montarTabela(normalFila, mainQueue);
        
        // Fila de completos (status 1 e 2)
        let superPrioridadeCompletos = superPrioridade.filter(item => item.status !== 0);
        let prioridadeCompletos = prioridade.filter(item => item.status !== 0);
        let normalCompletos = normal.filter(item => item.status !== 0);
        
        montarTabelaChamados(superPrioridadeCompletos, completedQueue);
        montarTabelaChamados(prioridadeCompletos, completedQueue);
        montarTabelaChamados(normalCompletos, completedQueue);
    }
    const filtrarPrioridade = (prioridade) => {
        return atendidos.filter(atendido => atendido.prioridade === prioridade);
    }
    const montarTabela = (lista, table) => {
        let options = {
            hour: "numeric",
            minute: "numeric",
            second: "numeric",
            hour12: false,
        };
        let senha;
        let bg;
        let txt;
        lista.map((item, index) => {
            if (item.status === 0) {
                switch (item.prioridade) {
                    case 2:
                        senha = `S${index + 1 < 10 ? "0" + (index + 1) : index}`;
                        bg = "bg-warning";
                        txt = "text-warning";
                        break;
                    case 1:
                        senha = `P${index < 10 ? "0" + (index + 1) : index}`;
                        bg = "bg-primary";
                        txt = "text-primary";
                        break;
                    case 0:
                        senha = `N${index < 10 ? "0" + (index + 1) : index}`;
                        bg = "bg-light";
                        txt = "text-dark";
                        break;
                }
                let format = new Intl.DateTimeFormat("pt-BR", options).format(new Date(item.hora));
                table.insertAdjacentHTML("beforeend", `
                    <tr class="${bg}">
                        <td class="${txt}">#${table.children.length + 1}</td>
                        <td class="${txt}">${item.nome}</td>
                        <td class="${txt}">${senha}</td>
                        <td class="${txt}">${format}</td>
                        <td class="${txt}">${item.psicologia}</td>
                        <td class="${txt}">
                            <span class="status-badge active"><small>Na fila</small></span>
                        </td>
                        <td class="action-buttons">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="buttonsActions(this, 1)" data-id="${item.id}">Chamar</button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="buttonsActions(this, 2)" data-id="${item.id}">Tirar da fila</button>
                        </td>
                    </tr>
                `)
            }
        })
    }
    const montarTabelaChamados = (lista, table) => {
        let options = {
            hour: "numeric",
            minute: "numeric",
            second: "numeric",
            hour12: false,
        };
        let senha;
        let bg;
        let txt;
        lista.map((item, index) => {
            if (item.status !== 0) {
                switch (item.prioridade) {
                    case 2:
                        senha = `S${index + 1 < 10 ? "0" + (index + 1) : index}`;
                        bg = "bg-warning";
                        txt = "text-warning";
                        break;
                    case 1:
                        senha = `P${index < 10 ? "0" + (index + 1) : index}`;
                        bg = "bg-primary";
                        txt = "text-primary";
                        break;
                    case 0:
                        senha = `N${index < 10 ? "0" + (index + 1) : index}`;
                        bg = "bg-light";
                        txt = "text-dark";
                        break;
                }
                let format = new Intl.DateTimeFormat("pt-BR", options).format(new Date(item.hora));
                table.insertAdjacentHTML("beforeend", `
                    <tr class="${bg}">
                        <td class="${txt}">#${table.children.length + 1}</td>
                        <td class="${txt}">${item.nome}</td>
                        <td class="${txt}">${senha}</td>
                        <td class="${txt}">${format}</td>
                        <td class="${txt}">${item.psicologia}</td>
                        <td>
                            ${item.status === 1 ? '<span class="status-badge active"><small>Chamado</small></span>' : '<span class="status-badge inactive"><small>Cancelado</small></span>'
                    }
                        </td>
                    </tr>
                `)
            }
        })
    }
    todosAtendidos();
    const today = new Intl.DateTimeFormat("pt-BR", options).format(new Date());
    document.querySelector(".page-header h1").innerHTML = `Fila de Atendimento - Hoje - <span>${today}</span>`;

</script>
{%endblock%}