{% extends "base/painel_principal.html" %}

{% block page_title %}Orientações Jurídicas{% endblock page_title %}
{% block titulo %}
<h1>Orientações Jurídicas</h1>
{% endblock titulo %}

{% block conteudo %}
<div class="page-container">
  <div class="page-header">
    <div class="search-section">
      <div class="search-form">
        <div class="search-field">
          <label>Buscar:</label>
          <input type="text" id="busca" class="form-control form-control-sm" 
                 placeholder="Área do direito, partes envolvidas..." 
                 aria-controls="table-2">
        </div>
      </div>
      
      <div class="total-info">
        <span>Total:</span>
        <span class="total-badge">
          {% if orientacoes.total is defined %}
            {{ orientacoes.total }}
          {% else %}
            {{ orientacoes|length if orientacoes else 0 }}
          {% endif %}
        </span>
      </div>
    </div>
    
    <div class="action-section">
      <a class="btn btn-primary" href="{{ url_for('orientacao_juridica.cadastro_orientacao_juridica') }}">
        Cadastrar Orientação Jurídica
      </a>
    </div>
  </div>

  <!-- Results Table -->
  {% if orientacoes and ((orientacoes.items and orientacoes.items|length > 0) or (orientacoes|length > 0 and not orientacoes.items)) %}
    <div class="table-container">
      <table class="results-table">
        <thead>
          <tr>
            <th>Área do Direito</th>
            <th>Partes Envolvidas</th>
            <th>Data/Hora de Criação</th>
            <th>Ações</th>
            <th></th>
            <th></th>
            <th></th>
          </tr> 
        </thead>
        <tbody id="tbody_orientacoes_juridicas">
          {% for orientacao in orientacoes.items %}
          <tr>
            <td>{{ orientacao.area_direito }}</td>
            <td>
              {% for atendido in orientacao.atendidos %}
                {{ atendido.nome }}<br />
              {% endfor %}
            </td>
            <td>{{ orientacao.data_criacao.strftime("%d/%m/%Y %H:%M") if orientacao.data_criacao else "--" }}</td>
            
            <td>
              <a href="{{ url_for('orientacao_juridica.perfil_oj', id=orientacao.id) }}" 
                 class="btn btn-primary" 
                 title="Visualizar orientação jurídica"
                 aria-label="Visualizar orientação jurídica {{ orientacao.area_direito }}">
                <i class="icon icon-eye" aria-hidden="true"></i>
                <span class="sr-only">Visualizar</span>
              </a>
            </td>
            
            <td>
              {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.PROFESSOR.value] %}
                <a href="{{ url_for('orientacao_juridica.editar_orientacao_juridica', id_oj=orientacao.id) }}" 
                   class="btn btn-primary" 
                   title="Editar orientação jurídica"
                   aria-label="Editar orientação jurídica {{ orientacao.area_direito }}">
                  <i class="icon icon-edit" aria-hidden="true"></i>
                  <span class="sr-only">Editar</span>
                </a>
              {% endif %}
            </td>
            
            <td>
              {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.ESTAGIARIO_DIREITO.value, UserRole.PROFESSOR.value] %}
                <button type="button" 
                        class="btn btn-primary" 
                        data-toggle="modal" 
                        data-target="#modalAssociarAtendido" 
                        data-orientacao-id="{{ orientacao.id }}"
                        title="Associar atendido"
                        aria-label="Associar atendido à orientação jurídica {{ orientacao.area_direito }}">
                  <i class="icon icon-link" aria-hidden="true"></i>
                  <span class="sr-only">Associar</span>
                </button>
              {% endif %}
            </td>
            
            <td>
              {% if current_user.urole == UserRole.ADMINISTRADOR.value %}
                <form action="{{ url_for('orientacao_juridica.excluir_oj') }}" method="POST" class="inline-form">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="id_orientacao" value="{{ orientacao.id }}">
                  <button type="submit" 
                          class="btn btn-danger" 
                          title="Excluir orientação jurídica"
                          aria-label="Excluir orientação jurídica {{ orientacao.area_direito }}"
                          onclick="return confirm('Você deseja realmente excluir essa orientação jurídica?');">
                    <i class="icon icon-trash" aria-hidden="true"></i>
                    <span class="sr-only">Excluir</span>
                  </button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination Info and Controls -->
    {% if orientacoes.pages is defined %}
    <div class="pagination-section">
      <!-- Results Info -->
      <div class="pagination-info">
        <span class="results-text">
          Mostrando 
          <strong>{{ orientacoes.first_item }}</strong> 
          até 
          <strong>{{ orientacoes.last_item }}</strong> 
          de 
          <strong>{{ orientacoes.total }}</strong> 
          registros
        </span>
        
        {% if orientacoes.pages > 1 %}
        <span class="page-info">
          Página {{ orientacoes.page }} de {{ orientacoes.pages }}
        </span>
        {% endif %}
      </div>

      <!-- Pagination Controls (only show if more than 1 page) -->
      {% if orientacoes.pages > 1 %}
      <nav class="pagination-nav">
        <ul class="pagination">
          {% if orientacoes.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('orientacao_juridica.orientacoes_juridicas', 
                page=orientacoes.prev_num) }}" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% endif %}
          
          {% for page_num in range(1, orientacoes.pages + 1) %}
          <li class="page-item {% if page_num == orientacoes.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('orientacao_juridica.orientacoes_juridicas', 
                page=page_num) }}">{{ page_num }}</a>
          </li>
          {% endfor %}
          
          {% if orientacoes.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('orientacao_juridica.orientacoes_juridicas', 
                page=orientacoes.next_num) }}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
    {% endif %}
    
  {% else %}
    <div class="empty-state">
      <h4>Nenhuma orientação jurídica encontrada</h4>
      <p class="empty-message">
        Não há orientações jurídicas cadastradas no momento
      </p>
      <a href="{{ url_for('orientacao_juridica.cadastro_orientacao_juridica') }}" class="btn btn-primary">
        Cadastrar nova orientação jurídica
      </a>
    </div>
  {% endif %}
</div>


{% endblock conteudo %}

{% block scripts %}
<style>
  /* Page Container */
  .page-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 24px;
    margin-bottom: 24px;
  }

  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .search-section {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .search-form {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .search-field {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-field label {
    font-weight: 500;
    color: #333;
    white-space: nowrap;
  }

  .search-field input,
  .search-field select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    min-width: 200px;
  }

  .search-field input:focus,
  .search-field select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }

  .total-info {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
  }

  .total-badge {
    background-color: var(--color-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
  }

  .action-section {
    display: flex;
    align-items: center;
  }

  /* Table */
  .table-container {
    overflow-x: auto;
    margin-bottom: 24px;
  }

  .results-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  .results-table th {
    background-color: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #dee2e6;
  }

  .results-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
  }

  .results-table tbody tr:hover {
    background-color: #f8f9fa;
  }

  .status-text {
    color: #6c757d;
    font-style: italic;
  }

  .inline-form {
    display: inline;
  }

  /* Pagination */
  .pagination-section {
    margin-top: 24px;
  }

  .pagination-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .results-text,
  .page-info {
    color: #6c757d;
    font-size: 14px;
  }

  .pagination-nav {
    display: flex;
    justify-content: center;
  }

  .pagination {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 4px;
  }

  .page-item {
    display: flex;
  }

  .page-link {
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    color: #007bff;
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.2s;
    cursor: pointer;
  }

  .page-link:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
  }

  .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: #6c757d;
  }

  .empty-state h4 {
    margin-bottom: 16px;
    color: #333;
  }

  .empty-message {
    margin-bottom: 24px;
    font-size: 16px;
  }

  /* Modal Styles */
  .modal-backdrop {
    z-index: 9998 !important;
  }
  .modal {
    z-index: 9999 !important;
    padding-left: 250px !important;
  }
  .modal-dialog {
    margin: 15vh auto 5vh auto !important;
    max-height: 80vh !important;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }

    .search-section {
      flex-direction: column;
      align-items: stretch;
    }

    .search-form {
      flex-direction: column;
      align-items: stretch;
    }

    .search-field {
      flex-direction: column;
      align-items: stretch;
    }

    .search-field input,
    .search-field select {
      min-width: auto;
    }

    .pagination-info {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .table-container {
      font-size: 14px;
    }

    .results-table th,
    .results-table td {
      padding: 8px;
    }
  }
</style>

<script>
    let busca = document.getElementById('busca');

    $('#busca').on({
        keyup: (event) => {
            $.ajax({
                method: "GET",
                url: `${window.origin}/orientacao_juridica/busca_oj/${busca.value}`,
                success: (result) => {
                    document.getElementById('tbody_orientacoes_juridicas').innerHTML = '';
                    $('tbody').append(result);
        }
            });
        }
    });
</script>

<script src="{{ url_for('static', filename='js/modal_associar_atendido.js') }}"></script>

{% endblock scripts %}
