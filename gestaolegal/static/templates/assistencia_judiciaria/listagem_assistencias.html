{% extends "base/painel_principal.html" %} 
{% block titulo %}Assistências Judiciárias{% endblock %} 

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_styles.css') }}">

<style>
#tbl_assistencias_judiciarias {
    min-height: 200px;
    transition: opacity 0.3s ease;
}

#tbl_assistencias_judiciarias.loading {
    opacity: 0.6;
    pointer-events: none;
}

.btn-icon {
    margin-right: 0.5rem;
    font-weight: bold;
}
</style>
{% endblock %}

{% import 'macros/listing.html' as listui %}
{% block conteudo %} 
      {% macro page_link(p) %}{{ url_for('assistencia_judiciaria.listar_assistencias_judiciarias', page=p, busca=busca, opcao_filtro=opcao_filtro) }}{% endmacro %}
      {% macro regiao_label(row) %}
        {% for key in assistencia_jud_regioes %}
          {% if assistencia_jud_regioes[key][0] == row.regiao %}
            {{ assistencia_jud_regioes[key][1] }}
          {% endif %}
        {% endfor %}
      {% endmacro %}
      {% macro areas_label(row) %}
        {% set vars = {'espaco': False} %}
        {% for key in assistencia_jud_areas_atendidas %}
          {% if assistencia_jud_areas_atendidas[key][0] in row.areas_atendidas %}
            {% if not vars.espaco %}
              <span>{{ assistencia_jud_areas_atendidas[key][1] }}</span>
              {% if vars.update({'espaco': True}) %}{% endif %}
            {% else %}
              <br><span>{{ assistencia_jud_areas_atendidas[key][1] }}</span>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endmacro %}
      {% macro actions_cell(row) %}
      {{ listui.action_buttons([
        {'label':'Visualizar','href':url_for('assistencia_judiciaria.perfil_assistencia_judiciaria', _id=row.id),'visible':true,'variant':'btn-primary'},
        {'label':'Editar','href':url_for('assistencia_judiciaria.editar_assistencia_judiciaria', id_assistencia_judiciaria=row.id),'visible': true,'variant':'btn-outline-primary'},
        {'label':'Excluir','href':url_for('assistencia_judiciaria.excluir_assistencia_judiciaria', id=row.id), 'method':'POST', 'csrf': csrf_token(), 'confirm':'Tem certeza que deseja excluir esta assistência judiciária?', 'visible': current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value], 'variant':'btn-outline-danger'}
      ]) }}
      {% endmacro %}
      {% set columns = [
        {'title':'Nome','key':'nome'},
        {'title':'Região','renderer': regiao_label},
        {'title':'Áreas do Direito','renderer': areas_label},
        {'title':'Telefone','key':'telefone'},
        {'title':'E-mail','key':'email'},
        {'title':'Ações','renderer': actions_cell}
      ] %}
      {% call(list_slot) listui.listing_layout(url_for('assistencia_judiciaria.listar_assistencias_judiciarias'), total=(assistencias.total if assistencias.total is defined else (assistencias.items|length if assistencias and assistencias.items else 0))) %}
        {% if list_slot == 'filters' %}
          <div class="search-field">
            <label for="busca">Buscar assistências</label>
            <input type="search" id="busca" name="busca" value="{{ busca or '' }}" placeholder="Digite para buscar..." aria-label="Buscar assistências judiciárias"/>
          </div>
          <div class="search-field">
            <label for="filtro">Filtrar por área</label>
            <select id="filtro" name="opcao_filtro" aria-label="Filtrar por área jurídica">
              <option value="{{filtro_busca_assistencia_judiciaria['TODAS'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['TODAS'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['TODAS'][1]}}</option>
              <option value="{{filtro_busca_assistencia_judiciaria['ADMINISTRATIVO'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['ADMINISTRATIVO'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['ADMINISTRATIVO'][1]}}</option>
              <option value="{{filtro_busca_assistencia_judiciaria['AMBIENTAL'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['AMBIENTAL'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['AMBIENTAL'][1]}}</option>
              <option value="{{filtro_busca_assistencia_judiciaria['CIVEL'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['CIVEL'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['CIVEL'][1]}}</option>
              <option value="{{filtro_busca_assistencia_judiciaria['EMPRESARIAL'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['EMPRESARIAL'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['EMPRESARIAL'][1]}}</option>
              <option value="{{filtro_busca_assistencia_judiciaria['PENAL'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['PENAL'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['PENAL'][1]}}</option>
              <option value="{{filtro_busca_assistencia_judiciaria['TRABALHISTA'][0]}}" {% if opcao_filtro == filtro_busca_assistencia_judiciaria['TRABALHISTA'][0] %}selected{% endif %}>{{filtro_busca_assistencia_judiciaria['TRABALHISTA'][1]}}</option>
            </select>
          </div>
        {% elif list_slot == 'header_actions' %}
          {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_EXTERNO.value, UserRole.COLAB_PROJETO.value, UserRole.PROFESSOR.value] %}
          <a href="{{ url_for('assistencia_judiciaria.cadastro_assistencia_judiciaria') }}" class="btn btn-primary btn-lg" aria-label="Cadastrar nova assistência judiciária"><span class="btn-icon">+</span>Cadastrar Assistência</a>
          {% endif %}
        {% elif list_slot == 'content' %}
          {% if assistencias and ((assistencias.items and assistencias.items|length > 0)) %}
            {{ listui.table(columns, assistencias.items, 'Lista de assistências judiciárias') }}
            {{ listui.pagination(assistencias, page_link) }}
          {% else %}
            {{ listui.empty_state('Nenhuma assistência judiciária cadastrada', 'Comece criando sua primeira assistência judiciária no sistema.', url_for('assistencia_judiciaria.cadastro_assistencia_judiciaria'), 'Cadastrar primeira assistência') }}
          {% endif %}
        {% endif %}
      {% endcall %}
{% endblock %} 

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.querySelector('.search-form');
    const buscaInput = document.getElementById('busca');
    const filtroSelect = document.getElementById('filtro');
    
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(searchForm);
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    params.set(key, value);
                }
            }
            
            window.location.href = searchForm.action + '?' + params.toString();
        });
    }
    
    if (filtroSelect) {
        filtroSelect.addEventListener('change', function() {
            searchForm.submit();
        });
    }
});
</script>
{% endblock scripts %}
