{% extends "base/painel_principal.html" %}
{%block titulo%}
    {{ title }}
{%endblock%}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form_styles.css') }}">
    <link rel="stylesheet" href="{{url_for('static',filename='temas_externos/select2.min.css')}}">
    <style>
    .select2-search--inline {
       display: contents; /*this will make the container disappear, making the child the one who sets the width of the element*/
    }
    .select2-search__field:placeholder-shown {
        width: 100% !important; /*makes the placeholder to be 100% of the width while there are no options selected*/
    }
    #clientes-js + span  .select2-selection__rendered{
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    #clientes-js + span .select2-selection__choice{
        float: none !important;
        margin: 0;
    }
    
    /* Files table styling */
    .files-table {
        margin: 1.5rem 0;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid var(--color-border, #e9ecef);
    }
    
    .files-table table {
        margin: 0;
        width: 100%;
    }
    
    .files-table th {
        background-color: var(--color-background, #f8f9fa);
        font-weight: 600;
        text-align: left;
        padding: 1rem;
        border-bottom: 1px solid var(--color-border, #e9ecef);
    }
    
    .files-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--color-border, #e9ecef);
        vertical-align: middle;
    }
    
    .file-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .file-actions .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    /* Hidden class for conditional fields */
    .hidden {
        display: none !important;
    }
    </style>

{% endblock css %}

{% block conteudo %}
<div class="form-container" id="pessoa">
    {% if caso %}
    <div class="form-header">
        <h3>Caso {{caso.id}}</h3>
        {% for cliente in caso.clientes %}
            <p>{{ cliente.nome }}</p>
        {% endfor %}
    </div>
    {% else %}
    <div class="form-header">
        <h3>Novo Caso</h3>
    </div>
    {% endif %}

    <div class="form-content">
        <form class="cadastro-form" action="" method="POST" id="form" enctype="multipart/form-data">
            {% include "casos/formularios/formulario_base_caso.html" %}
            {% if arquivos %}
            <div class="form-section">
                <h3>Arquivos do Caso</h3>
            </div>
            
            <div class="files-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Título do Arquivo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for arquivo in arquivos %}
                    <tr>
                        <td>{{arquivo.link_arquivo}}</td>
                        <td>
                            <div class="file-actions">
                                <a class="btn btn-info" href="{{url_for('static', filename='casos/'+arquivo.link_arquivo)}}">Visualizar</a>
                                {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value, UserRole.COLAB_EXTERNO.value, UserRole.PROFESSOR.value, UserRole.ORIENTADOR.value]%}
                                <a href="{{url_for('casos.editar_arquivo_caso',id_arquivo=arquivo.id, id_caso=caso.id)}}" class="btn btn-primary">Editar</a>
                                {% endif %}
                                {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.ORIENTADOR.value, UserRole.PROFESSOR.value] %}
                                <a href="{{url_for('casos.excluir_arquivo_caso', id_arquivo=arquivo.id, id_caso=caso.id)}}" class="btn btn-danger">Excluir</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <div class="form-section">
                <h3>Adicionar Arquivo</h3>
            </div>
            
            <div class="form-field">
                <div class="field-row">
                    <label for="arquivo">Upload de arquivo <span class="required">(.pdf)(Máx: 10MB)</span></label>
                    <div class="field-input">
                        <input type="file" name="arquivo" class="form-input" accept=".pdf">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                {{form.submit(class_='btn btn-primary')}}
            </div>
        </form>
    </div>
</div>
    {% endblock %}

{% block scripts %}
    <script src="{{url_for('static',filename='js/select2.min.js')}}"></script>
    <script src="{{url_for('static',filename='js/subarea_caso.js')}}"></script>
    <script>
        validarCampoAreaDireito();
        document.getElementById("area_direito-js").onchange = function() {validarCampoAreaDireito()};
        document.getElementById("sub_area-js").onchange = function() {validarCampoAreaDireito()};
        document.getElementById("sub_area_admin-js").onchange = function() {validarCampoAreaDireito()};
    </script>

    <script>
        $(document).ready(function(){

            trocaLinkRoteiro();

            let placeholder_orientador = 'Pesquisar orientadores';
            let placeholder_estagiario = 'Pesquisar estagiários';
            let placeholder_colaborador = 'Pesquisar colaboradores';

            {% if caso %}
                {% if caso.orientador.nome %}
                    placeholder_orientador =  '{{ caso.orientador.nome }}'
                {% endif %}
                {% if caso.estagiario.nome %}
                    placeholder_estagiario =  '{{ caso.estagiario.nome }}'
                {% endif %}
                {% if caso.colaborador.nome %}
                    placeholder_colaborador =  '{{ caso.colaborador.nome }}'
                {% endif %}
            {% endif %}



    $('#orientador-js').select2({
        ajax: {
            url: $('#apiCasosBuscarOrientador').val(),
            dataType: 'json',
        },
        delay: 500,
        placeholder: placeholder_orientador,
        width: '100%'
    });

    $('#orientador-js').on('change', function(){
        $('#orientador').val($('#orientador-js').val());
    });

    $('#estagiario-js').select2({
        ajax: {
            url: $('#apiCasosBuscarEstagiario').val(),
            dataType: 'json',
        },
        delay: 500,
        placeholder: placeholder_estagiario,
        width: '100%'
    })

    $('#estagiario-js').on('change', function(){
        $('#estagiario').val($('#estagiario-js').val());
    });

    $('#colaborador-js').select2({
        ajax: {
            url: $('#apiCasosBuscarColaborador').val(),
            dataType: 'json',
        },
        delay: 500,
        placeholder: placeholder_colaborador,
        width: '100%'
    })

    $('#colaborador-js').on('change', function(){
        $('#colaborador').val($('#colaborador-js').val());
    });


    $('#clientes-js').select2({
        ajax: {
            url: $('#apiCasosBuscarAtendido').val(),
            dataType: 'json',
        },
        multiple: true,
        delay: 500,
        placeholder: 'Pesquisar assistido ',
        width: '100%',

    });

    $('#clientes-js').css('width', '100%');


    $('#clientes-js').on('change', function(){
        $('#clientes').val($('#clientes-js').val().join(','));
    });


    $('#area_direito-js').on('change',function(){
        trocaLinkRoteiro();
    });

    function trocaLinkRoteiro(){
        $.ajax({
            url: $('#apiCasosBuscarRoteiro').val(),
            data:{termo: $('#area_direito-js').val()}
          }).done(function(data) {
              if (data.link){
                $('#link-roteiro').attr('href', data.link);
                $('#link-roteiro').removeClass('disabled');
              }else{
                $('#link-roteiro').addClass('disabled');
              }
          });
    }
})
    </script>
    <script defer>
        window.onload = () => {
            const orientacao = JSON.parse(localStorage.getItem("case"));
            if(orientacao !== null){
                // document.querySelector(".select2-search__field").click()
                newOption = new Option(orientacao.nome_atendido, orientacao.id_atendido, false, false);
                $('#clientes-js').append(newOption).trigger('change');
                const form = document.querySelector("#form");
                const evt = document.createEvent("HTMLEvents");
                evt.initEvent("change", true, true);
                form.area_direito.value = orientacao['area_direito-js'];
                form.descricao.value = orientacao['descricao'];
                form['sub_area_admin-js'].value = orientacao['sub_area_admin-js'];
                form.area_direito.dispatchEvent(evt);
                form.clientes.value = orientacao.id_atendido;
            }
            localStorage.removeItem("case");
        }
    </script>
{% endblock scripts %}