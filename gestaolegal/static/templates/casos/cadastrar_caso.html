{% extends "base/painel_principal.html" %}
{% from "base/base_form.html" import form_field, form_section %}
{%block titulo%}
    {{ title }}
{%endblock%}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form_styles.css') }}">
    <link rel="stylesheet" href="{{url_for('static',filename='css/native_select.css')}}">
    <link rel="stylesheet" href="{{url_for('static',filename='css/table_styles.css')}}">
{% endblock css %}

{% block conteudo %}
<div class="form-container" id="pessoa">
    <div class="form-content" style="padding-top: 0;">
        <form class="cadastro-form" action="" method="POST" id="form" enctype="multipart/form-data">
            {% include "casos/formularios/formulario_base_caso.html" %}
            {% if arquivos %}
            {{ form_section("Arquivos do Caso") }}
            
            <div class="files-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Título do Arquivo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for arquivo in arquivos %}
                    <tr>
                        <td>{{arquivo.link_arquivo}}</td>
                        <td>
                            <div class="file-actions">
                                <a class="btn btn-info" href="{{url_for('static', filename='casos/'+arquivo.link_arquivo)}}">Visualizar</a>
                                {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value, UserRole.COLAB_EXTERNO.value, UserRole.PROFESSOR.value, UserRole.ORIENTADOR.value]%}
                                <a href="{{url_for('casos.editar_arquivo_caso',id_arquivo=arquivo.id, id_caso=caso.id)}}" class="btn btn-primary">Editar</a>
                                {% endif %}
                                {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.ORIENTADOR.value, UserRole.PROFESSOR.value] %}
                                <a href="{{url_for('casos.excluir_arquivo_caso', id_arquivo=arquivo.id, id_caso=caso.id)}}" class="btn btn-danger">Excluir</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            {{ form_section("Adicionar Arquivo") }}
            
            <div class="form-field">
                <div class="field-row">
                    <label for="arquivo">Upload de arquivo <span class="required">(.pdf)(Máx: 10MB)</span></label>
                    <div class="field-input">
                        <input type="file" name="arquivo" id="arquivo" accept=".pdf">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                {{form.submit(class_='btn btn-primary')}}
            </div>
        </form>
    </div>
</div>
    {% endblock %}

{% block scripts %}
    <script src="{{url_for('static',filename='js/native_select.js')}}"></script>
    <script src="{{url_for('static',filename='js/form_utilities.js')}}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            FormUtils.initializeForm({
                formId: 'form',
                buttonId: 'submit',
                masks: [],
                conditionalFields: [
                    {
                        triggerId: 'area_direito',
                        fieldsToToggle: ['div_sub_area'],
                        condition: (trigger) => {
                            const selectedText = trigger.options[trigger.selectedIndex]?.text;
                            return selectedText === 'Civel';
                        }
                    },
                    {
                        triggerId: 'area_direito',
                        fieldsToToggle: ['div_sub_area_admin'],
                        condition: (trigger) => {
                            const selectedText = trigger.options[trigger.selectedIndex]?.text;
                            return selectedText === 'Administrativo';
                        }
                    }
                ],
                dateRanges: [],
                preventWheel: true
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function(){
            trocaLinkRoteiro();

            const placeholders = {
                orientador: 'Pesquisar orientadores',
                estagiario: 'Pesquisar estagiários',
                colaborador: 'Pesquisar colaboradores'
            };

            {% if caso %}
                {% if caso.orientador and caso.orientador.nome %}
                    placeholders.orientador = '{{ caso.orientador.nome }}';
                {% endif %}
                {% if caso.estagiario and caso.estagiario.nome %}
                    placeholders.estagiario = '{{ caso.estagiario.nome }}';
                {% endif %}
                {% if caso.colaborador and caso.colaborador.nome %}
                    placeholders.colaborador = '{{ caso.colaborador.nome }}';
                {% endif %}
            {% endif %}

            const apiEndpoints = {
                orientador: document.getElementById('apiCasosBuscarOrientador').value,
                estagiario: document.getElementById('apiCasosBuscarEstagiario').value,
                colaborador: document.getElementById('apiCasosBuscarColaborador').value,
                atendido: document.getElementById('apiCasosBuscarAtendido').value,
                roteiro: document.getElementById('apiCasosBuscarRoteiro').value
            };

            initializeNativeSelectField('orientador-js', apiEndpoints.orientador, placeholders.orientador, 'orientador');
            initializeNativeSelectField('estagiario-js', apiEndpoints.estagiario, placeholders.estagiario, 'estagiario');
            initializeNativeSelectField('colaborador-js', apiEndpoints.colaborador, placeholders.colaborador, 'colaborador');

            {% if not caso %}
            initializeNativeSelectField('clientes-js', apiEndpoints.atendido, 'Pesquisar assistido', 'clientes', true);
            {% endif %}

            const areaDireitoField = document.getElementById('area_direito');
            if (areaDireitoField) {
                areaDireitoField.addEventListener('change', trocaLinkRoteiro);
            }

            function initializeNativeSelectField(selectId, apiUrl, placeholder, hiddenFieldId, multiple = false) {
                const selectElement = document.getElementById(selectId);
                const hiddenField = document.getElementById(hiddenFieldId);
                
                if (!selectElement) return;

                const nativeSelect = new NativeSelect(selectElement, {
                    ajax: {
                        url: apiUrl,
                        delay: 500,
                        params: (searchTerm) => ({ q: searchTerm })
                    },
                    placeholder: placeholder,
                    width: '100%',
                    multiple: multiple,
                    allowClear: true
                });

                {% if caso %}
                    {% if selectId == 'orientador-js' and caso.orientador %}
                        nativeSelect.val('{{ caso.orientador.id }}');
                    {% elif selectId == 'estagiario-js' and caso.estagiario %}
                        nativeSelect.val('{{ caso.estagiario.id }}');
                    {% elif selectId == 'colaborador-js' and caso.colaborador %}
                        nativeSelect.val('{{ caso.colaborador.id }}');
                    {% endif %}
                {% endif %}

                selectElement.addEventListener('change', function() {
                    if (hiddenField) {
                        if (multiple) {
                            const values = nativeSelect.val() || [];
                            hiddenField.value = values.join(',');
                        } else {
                            hiddenField.value = nativeSelect.val() || '';
                        }
                    }
                });
            }

            async function trocaLinkRoteiro(){
                const areaField = document.getElementById('area_direito');
                const linkElement = document.getElementById('link-roteiro');
                
                if (!areaField || !linkElement) return;

                try {
                    const response = await fetch(apiEndpoints.roteiro, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `termo=${encodeURIComponent(areaField.value)}`
                    });
                    
                    const data = await response.json();
                    
                    if (data.link && linkElement) {
                        linkElement.href = data.link;
                        linkElement.classList.remove('disabled');
                    } else {
                        linkElement.classList.add('disabled');
                    }
                } catch (error) {
                    console.error('Error fetching roteiro link:', error);
                    if (linkElement) {
                        linkElement.classList.add('disabled');
                    }
                }
            }
        });
    </script>
    <script defer>
        window.addEventListener('load', () => {
            try {
                const orientacao = JSON.parse(localStorage.getItem("case"));
                if (orientacao !== null) {
                    populateFormFromStorage(orientacao);
                    localStorage.removeItem("case");
                }
            } catch (error) {
                console.error('Error parsing case data from localStorage:', error);
                localStorage.removeItem("case");
            }
        });

        function populateFormFromStorage(data) {
            if (data.nome_atendido && data.id_atendido) {
                const clientesSelect = document.getElementById('clientes-js');
                if (clientesSelect) {
                    const newOption = new Option(data.nome_atendido, data.id_atendido, false, false);
                    clientesSelect.appendChild(newOption);
                    clientesSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }

            const form = document.querySelector("#form");
            if (form) {
                if (data['area_direito-js']) {
                    form.area_direito.value = data['area_direito-js'];
                    form.area_direito.dispatchEvent(new Event('change', { bubbles: true }));
                }

                if (data.descricao) {
                    form.descricao.value = data.descricao;
                }

                if (data['sub_area_admin-js']) {
                    form['sub_area_admin-js'].value = data['sub_area_admin-js'];
                }

                if (data.id_atendido) {
                    form.clientes.value = data.id_atendido;
                }
            }
        }
    </script>
{% endblock scripts %}