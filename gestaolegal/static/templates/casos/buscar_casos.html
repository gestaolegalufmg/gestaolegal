{% from 'plantao/componentes/field_template.html' import card_field %}
{% from 'plantao/componentes/card_template.html' import card %}

{% if casos.pages > 1 %}
<div class="pagination-section">
  <div class="pagination-info">
    <span class="results-text">
      Mostrando 
      <strong>{{ casos.first_item }}</strong> 
      até 
      <strong>{{ casos.last_item }}</strong> 
      de 
      <strong>{{ casos.total }}</strong> 
      registros
    </span>
    
    <span class="page-info">
      Página {{ casos.page }} de {{ casos.pages }}
    </span>
  </div>

  <nav class="pagination-nav">
    <ul class="pagination">
      {% if casos.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for(rota_paginacao, page=casos.prev_num, opcao_filtro=opcao_filtro) }}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      {% endif %}
      
      {% for page_num in casos.iter_pages(left_edge=3, right_edge=3, left_current=2, right_current=2) %} 
        {% if page_num and casos.page == page_num%}
          <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
        {% elif page_num %}
          {% if opcao_filtro %}
            <li class="page-item"><a class="page-link" href="{{ url_for(rota_paginacao, page=page_num, opcao_filtro=opcao_filtro) }}">{{ page_num }}</a></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="{{ url_for(rota_paginacao, page=page_num) }}">{{ page_num }}</a></li>
          {% endif %}
        {% else %}
          <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
        {% endif %} 
      {% endfor %}
      
      {% if casos.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for(rota_paginacao, page=casos.next_num, opcao_filtro=opcao_filtro) }}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endif %}

<div class="col-12 mt-4">
  <h3>{{titulo_total}}</h3>   
</div>
{% for caso in casos.items %}
    <div class="col-12 col-md-6 col-lg-6 mb-4">
        {% set header_content %}
            <h4>Caso {{caso.id}}</h4>
            {% for key in situacao_deferimento %}
            {% if situacao_deferimento[key][0] == caso.situacao_deferimento %}
            <div class="card-header-action">
                <span class="status-badge {{situacao_deferimento[key][2]}}">
                    {{situacao_deferimento[key][1]}} 
                </span>
            </div>
            {% endif %}
            {% endfor %}
        {% endset %}

        {% set body_content %}
            {{ card_field(title="Estagiário de direito", value=caso.estagiario.nome) }}
            
            <div class="field-container">
              <div class="field-label">Assistido(s):</div>
              <div class="field-value">
                {% for cliente in caso.clientes %}
                  {{cliente.nome}}<br>
                {% endfor %}
                <a href="#" 
                   class="text-primary gerenciar-assistidos-link" 
                   data-caso-id="{{caso.id}}"
                   style="text-decoration: underline; cursor: pointer;">
                   Gerenciar assistidos
                </a>
              </div>
            </div>
            
            {{ card_field(title="Orientador", value=caso.orientador.nome) }}
            
            {{ card_field(title="Criado em", value=caso.data_criacao.strftime("%d/%m/%Y %H:%M:%S")) }}
            
            {{ card_field(title="Última modificação", value=caso.data_modificacao.strftime("%d/%m/%Y %H:%M:%S")) }}
            
            <div class="field-container">
              <div class="field-label">Último processo:</div>
              <div class="field-value">
                {% if caso.numero_ultimo_processo is not none%}
                <a href="{{url_for('processo.visualizar_processo_com_numero', numero_processo = caso.numero_ultimo_processo)}}">{{caso.numero_ultimo_processo}}</a>
                {% else %}
                  --
                {%endif %}
              </div>
            </div>
        {% endset %}

        {% set footer_content %}
            <div class="action-buttons">
              <input type="hidden" value="{{url_for('casos.excluir_caso', id_caso=caso.id)}}" id="url_excluir_caso{{caso.id}}">

              <div class="action-group-left">
                <a href="{{url_for('casos.visualizar_caso', id=caso.id)}}" 
                   class="btn btn-primary" 
                   title="Visualizar caso"
                   aria-label="Visualizar caso {{caso.id}}">
                  <i class="icon icon-eye" aria-hidden="true"></i>
                  <span class="sr-only">Visualizar</span>
                </a>
                
                {% if current_user.urole in [UserRole.ADMINISTRADOR.value,UserRole.PROFESSOR.value,UserRole.ORIENTADOR.value,UserRole.COLAB_EXTERNO.value, UserRole.ESTAGIARIO_DIREITO.value] %}
                <a href="{{url_for('casos.editar_caso', id_caso = caso.id)}}" 
                   class="btn btn-outline" 
                   title="Editar caso"
                   aria-label="Editar caso {{caso.id}}">
                  <i class="icon icon-edit" aria-hidden="true"></i>
                  <span class="sr-only">Editar</span>
                </a>
                {% endif %}

                {% if current_user.urole == UserRole.ADMINISTRADOR.value %}
                    <button class="btn btn-outline-danger" 
                            data-toggle="modal" 
                            data-target="excluir"
                            title="Excluir caso"
                            aria-label="Excluir caso {{caso.id}}">
                        <a id_caso="{{caso.id}}" id="a_excluir{{caso.id}}"
                            onclick="excluir_caso(document.getElementById('url_excluir_caso{{caso.id}}').value)">
                            <i class="icon icon-trash" aria-hidden="true"></i>
                            <span class="sr-only">Excluir</span>
                        </a>
                    </button>
                {% endif %}
              </div>

              {% if current_user.urole in [UserRole.PROFESSOR.value, UserRole.ADMINISTRADOR.value] %}
                  {% if caso.situacao_deferimento == 'aguardando_deferimento' %}
                  <div class="action-group-right">
                      <input type="hidden" value="{{url_for('casos.deferir_caso', id_caso=caso.id)}}" id="url_deferir_caso{{caso.id}}">
                      <input type="hidden" value="{{url_for('casos.indeferir_caso', id_caso=caso.id)}}" id="url_indeferir_caso{{caso.id}}">
                      <button class="btn btn-success" 
                              data-toggle="modal" 
                              data-target="deferir"
                              title="Deferir caso"
                              aria-label="Deferir caso {{caso.id}}">
                          <a id_caso="{{caso.id}}" id="a_deferir{{caso.id}}"
                              onclick="deferir_caso(document.getElementById('url_deferir_caso{{caso.id}}').value)">
                              <i class="icon icon-check" aria-hidden="true"></i>
                              <span class="sr-only">Deferir</span>
                          </a>
                      </button>
                      <button class="btn btn-outline-danger" 
                              data-toggle="modal" 
                              data-target="indeferir"
                              title="Indeferir caso"
                              aria-label="Indeferir caso {{caso.id}}">
                          <a id_caso="{{caso.id}}" id="a_indeferir"
                              onclick="indeferir_caso(document.getElementById('url_indeferir_caso{{caso.id}}').value)">
                              <i class="icon icon-close" aria-hidden="true"></i>
                              <span class="sr-only">Indeferir</span>
                          </a>
                      </button>
                  </div>
                  {% endif %}
              {% endif %}
            </div>
        {% endset %}

        {{ card(header=header_content, body=body_content, footer=footer_content) }}
    </div>
{% endfor %}

{% include 'casos/componentes/modal_gerenciar_assistidos.html' %}

{% block scripts %}
<script src="{{url_for('static',filename='js/modal_gerenciar_assistidos.js')}}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('gerenciar-assistidos-link')) {
            event.preventDefault();
            const casoId = event.target.getAttribute('data-caso-id');
            abrirModalGerenciarAssistidos(casoId);
        }
    });
});

function abrirModalGerenciarAssistidos(casoId) {
    window.currentCasoId = casoId;
    window.ModalManager.open('modalGerenciarAssistidos');
}
</script>
{% endblock %}