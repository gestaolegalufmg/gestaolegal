{% extends "base/painel_principal.html" %}

{% block page_title %}Gestão de Arquivos{% endblock page_title %}
{% block titulo %}
<h1>Gestão de Arquivos</h1>
{% endblock titulo %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_styles.css') }}">
{% endblock %}

{% import 'macros/listing.html' as listui %}
{% block conteudo %}
{% macro page_link(p) %}{{ url_for('arquivos.index', page=p, search=search) }}{% endmacro %}
{% macro titulo_label(row) %}{{ row.titulo }}{% endmacro %}
{% macro actions_cell(row) %}
{{ listui.action_buttons([
  {'label':'Visualizar','href':url_for('arquivos.visualizar_arquivo', id=row.id),'visible':true,'variant':'btn-primary'},
  {'label':'Editar','href':url_for('arquivos.editar_arquivo', id=row.id),'visible': current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value, UserRole.COLAB_EXTERNO.value, UserRole.PROFESSOR.value],'variant':'btn-primary'},
  {'label':'Excluir','href':url_for('arquivos.excluir_arquivo', id=row.id),'visible':true,'variant':'btn-danger'}
]) }}
{% endmacro %}
{% set columns = [
  {'title':'Título do Arquivo','renderer': titulo_label},
  {'title':'Ações','renderer': actions_cell}
] %}
{% call(list_slot) listui.listing_layout(url_for('arquivos.index'), total=(arquivos.total if arquivos.total is defined else (arquivos.items|length if arquivos and arquivos.items else 0)), aria_label='Filtros de busca de arquivos') %}
  {% if list_slot == 'filters' %}
    <div class="search-field">
      <label for="searchFile">Buscar:</label>
      <input type="text" name="search" value="{{ search or '' }}" placeholder="Título do arquivo..." id="searchFile" aria-describedby="search-help" autocomplete="off">
      <div id="search-help" class="sr-only">Digite o título do arquivo que deseja buscar</div>
    </div>
  {% elif list_slot == 'header_actions' %}
    {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value, UserRole.COLAB_EXTERNO.value, UserRole.PROFESSOR.value] %}
    <a class="btn btn-primary" href="{{ url_for('arquivos.cadastrar_arquivo') }}">Adicionar Arquivo</a>
    {% endif %}
  {% elif list_slot == 'content' %}
    {% if arquivos and arquivos.items and arquivos.items|length > 0 %}
      {{ listui.table(columns, arquivos.items, 'Lista de arquivos do sistema') }}
      {{ listui.pagination(arquivos, page_link) }}
    {% else %}
      {{ listui.empty_state('Nenhum arquivo encontrado', search and ('Não foram encontrados resultados para "' ~ search ~ '"') or 'Não há arquivos cadastrados no momento', (current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value, UserRole.COLAB_EXTERNO.value, UserRole.PROFESSOR.value]) and url_for('arquivos.cadastrar_arquivo') or None, (current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.COLAB_PROJETO.value, UserRole.COLAB_EXTERNO.value, UserRole.PROFESSOR.value]) and 'Adicionar novo arquivo' or None) }}
    {% endif %}
  {% endif %}
{% endcall %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.querySelector('.search-form');
    const searchInput = document.querySelector("#searchFile");
    
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(searchForm);
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    params.set(key, value);
                }
            }
            
            window.location.href = searchForm.action + '?' + params.toString();
        });
    }
});
</script>
{% endblock %}