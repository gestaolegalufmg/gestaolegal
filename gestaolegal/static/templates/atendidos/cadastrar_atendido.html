{% extends "base/painel_principal.html" %}
{%block titulo%}Cadastrar Atendido{%endblock%}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/form_styles.css') }}">
<style>
</style>
{% endblock %}
{% block conteudo %}
<div class="form-container" id="pessoa">
    <div class="form-content">
        <form class="cadastro-form" action="{{url_for('atendido.cadastrar_atendido')}}" method="POST" id="form" novalidate>

            {% include "atendidos/formularios/formulario_atendido.html" %}

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submitBtn">Cadastrar</button>
                <button type="button" id="insertQueue" class="btn btn-outline">Cadastrar e incluir na fila de atendimento</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block modal %}
<div class="modal-overlay modal-hidden" 
     id="senhaModal" 
     role="dialog" 
     aria-modal="true" 
     aria-labelledby="senhaModal_title"
     aria-describedby="senhaModal_body">
    <div class="modal-content modal-lg" tabindex="-1">
        <div class="modal-header">
            <h2 class="modal-title" id="senhaModal_title">Escolha o tipo de senha</h2>
            <button type="button" class="modal-close" onclick="ModalManager.close('senhaModal')" aria-label="Fechar modal">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body" id="senhaModal_body">
            <div class="modal-main-content">
                <div class="radio-option">
                    <input type="radio" name="senha" value="N" id="senhaNormal">
                    <div class="radio-content">
                        <label for="senhaNormal">Normal</label>
                        <p>Público em geral</p>
                    </div>
                </div>
                <div class="radio-option">
                    <input type="radio" name="senha" value="P" id="senhaPrioridade">
                    <div class="radio-content">
                        <label for="senhaPrioridade">Prioridade</label>
                        <p>Idosos até 80 anos; pessoas com deficiência; gestantes; lactantes; pessoas com
                            crianças de colo e obesos</p>
                    </div>
                </div>
                <div class="radio-option">
                    <input type="radio" name="senha" value="S" id="senhaSuperPrioridade">
                    <div class="radio-content">
                        <label for="senhaSuperPrioridade">Super Prioridade</label>
                        <p>Idosos acima de 80 anos.</p>
                    </div>
                </div>
            </div>
            <div class="modal-separator"></div>
            <div class="modal-password-section">
                <div class="loading-spinner modal-hidden">
                    <span>Carregando...</span>
                </div>
                <div class="password-display modal-hidden">
                    <p>Senha do atendido</p>
                    <p class="password-number"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-options">
                <div class="checkbox-option">
                    <input type="checkbox" name="setor" value="1" id="psicologia">
                    <label for="psicologia">Há atendimento da psicologia</label>
                </div>
                <div class="modal-buttons">
                    <button id="closeModal" type="button" class="btn btn-secondary" onclick="ModalManager.close('senhaModal')">Voltar</button>
                    <button id="createQueue" type="button" class="btn btn-primary">Cadastrar e Incluir na Fila</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{url_for('static',filename='js/form_utilities.js')}}"></script>
<script>
    const PRIORITY_MAPPING = {
        'N': 0,
        'P': 1,
        'S': 2
    };

    const getPriorityValue = (priorityStr) => {
        return PRIORITY_MAPPING[priorityStr] ?? 0;
    };

    const showModal = () => {
        ModalManager.open('senhaModal');
    };

    const hideModal = () => {
        ModalManager.close('senhaModal');
    };

    const cadastrarAtendido = async () => {
        try {
            const formData = new FormData(form);
            const obj = Object.fromEntries(formData.entries());

            const booleanFields = ['procurou_outro_local', 'pj_constituida', 'repres_legal', 'pretende_constituir_pj'];
            booleanFields.forEach(field => {
                if (obj[field] !== undefined) {
                    obj[field] = obj[field] === 'true' || obj[field] === true;
                }
            });

            const response = await fetch("{{url_for('api.cadastrar_atendido')}}", {
                method: "POST",
                headers: {
                    'X-CSRF-Token': FormUtils.getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(obj)
            });

            const payload = await response.json();
            if (response.ok && payload?.data?.id) {
                clearFieldErrors();
                return payload.data.id;
            }
            applyServerErrors(payload);
            throw new Error(payload?.message || 'Erro ao cadastrar atendido');
        } catch (error) {
            console.error('Erro ao cadastrar atendido:', error);
            throw error;
        }
    };

    const gerarSenha = async (prioridadeStr) => {
        const loadingSpinner = document.querySelector('.loading-spinner');
        const passwordDisplay = document.querySelector('.password-display');
        
        loadingSpinner.classList.remove('modal-hidden');
        passwordDisplay.classList.add('modal-hidden');

        try {
            const prioridade = getPriorityValue(prioridadeStr);
            const response = await fetch(`/plantao/fila-atendimento/gerar-senha/${prioridade}`, {
                headers: {
                    'X-CSRF-Token': FormUtils.getCSRFToken(),
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            setTimeout(() => {
                loadingSpinner.classList.add('modal-hidden');
                passwordDisplay.classList.remove('modal-hidden');
                document.querySelector('.password-number').textContent = `${prioridadeStr}${data.senha}`;
            }, 800);
        } catch (error) {
            console.error('Erro ao gerar senha:', error);
            loadingSpinner.classList.add('modal-hidden');
            alert('Erro ao gerar senha. Tente novamente.');
        }
    };

    const criarAtendimento = async (idAtendido) => {
        try {
            const radio = document.querySelector('.modal-main-content input[type=radio]:checked');
            const psicologia = document.querySelector('.modal-footer input[type=checkbox]').checked;
            const senha = document.querySelector('.password-number').textContent;

            if (!radio) {
                alert('Por favor, selecione um tipo de senha.');
                return;
            }

            const prioridade = getPriorityValue(radio.value);
            const obj = {
                prioridade,
                psicologia: psicologia ? 1 : 0,
                senha,
                id_atendido: idAtendido
            };

            const response = await fetch("{{url_for('api.criar_fila_plantao')}}", {
                method: "POST",
                headers: {
                    'X-CSRF-Token': FormUtils.getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(obj)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.message === "success") {
                window.location.href = "{{url_for('plantao.fila_atendimento')}}";
            } else {
                throw new Error('Erro ao criar atendimento');
            }
        } catch (error) {
            console.error('Erro ao criar atendimento:', error);
            alert('Erro ao criar atendimento. Tente novamente.');
        }
    };

    // Event handlers
    const handleInsertQueue = async (e) => {
        e.preventDefault();
        
        if (!FormUtils.validateForm(e)) {
            return;
        }

        try {
            const idAtendido = await cadastrarAtendido();
            showModal();
        } catch (error) {
            // Error already handled in cadastrarAtendido
        }
    };

    const handleCreateQueue = async () => {
        try {
            const idAtendido = await cadastrarAtendido();
            await criarAtendimento(idAtendido);
        } catch (error) {
            // Error already handled in respective functions
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        FormUtils.initializeFormWithValidation({
            formId: 'form',
            buttonId: 'submitBtn',
            masks: [
                { selector: '#formcpf', pattern: FormUtils.MASK_PATTERNS.CPF },
                { selector: '#formcpfrepr', pattern: FormUtils.MASK_PATTERNS.CPF },
                { selector: '#formcnpj', pattern: FormUtils.MASK_PATTERNS.CNPJ },
                { selector: '#formcel', pattern: FormUtils.MASK_PATTERNS.CELL_PHONE },
                { selector: '#formtel', pattern: FormUtils.MASK_PATTERNS.PHONE },
                { selector: '#formcep', pattern: FormUtils.MASK_PATTERNS.CEP }
            ],
            conditionalFields: [
                {
                    triggerId: 'pj_constituida',
                    fieldsToToggle: ['div_cnpj'],
                    condition: (trigger) => trigger.value === 'True'
                },
                {
                    triggerId: 'pj_constituida',
                    fieldsToToggle: ['div_repres_legal'],
                    condition: (trigger) => trigger.value === 'True'
                },
                {
                    triggerId: 'repres_legal',
                    fieldsToToggle: ['div_nome_repres_legal', 'div_cpf_repres_legal', 'div_contato_repres_legal', 'div_nascimento_repres_legal', 'div_rg_repres_legal'],
                    condition: (trigger) => trigger.value === '0'
                },
                {
                    triggerId: 'como_conheceu',
                    fieldsToToggle: ['div_indicacao_orgao'],
                    condition: (trigger) => trigger.options[trigger.selectedIndex]?.text === '{{como_conheceu_daj["ORGAOSPUBLICOS"][1]}}'
                },
                {
                    triggerId: 'procurou_outro_local',
                    fieldsToToggle: ['div_procurou_qual_local'],
                    condition: (trigger) => trigger.value === 'True'
                }
            ],
            dateRanges: [],
            preventWheel: true,
            enableValidation: true
        });

        document.querySelectorAll(".modal-main-content input[type=radio]").forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.checked) {
                    gerarSenha(radio.value);
                }
            });
        });
    });
</script>
{%endblock%}
