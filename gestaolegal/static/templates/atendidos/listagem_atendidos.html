{% extends "base/painel_principal.html" %}

{% block page_title %}Atendidos e Assistidos{% endblock page_title %}
{% block titulo %}
<h1>Atendidos e Assistidos</h1>
{% endblock titulo %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table_styles.css') }}">
{% endblock %}

{% import 'macros/listing.html' as listui %}
{% block conteudo %}
{% macro page_link(p) %}{{ url_for('atendido.listagem_atendidos', page=p, valor_busca=valor_busca, tipo_busca=tipo_busca) }}{% endmacro %}
{% macro cpf_label(row) %}{{ row.cpf or '--' }}{% endmacro %}
{% macro cnpj_label(row) %}{{ row.cnpj or '--' }}{% endmacro %}
{% macro telefone_label(row) %}{{ row.telefone or '--' }}{% endmacro %}
{% macro actions_cell(row) %}
{{ listui.action_buttons([
  {'label':'Visualizar','href':url_for('atendido.visualizar_atendido', atendido_id=row.id),'visible':true,'variant':'btn-primary'},
  {'label':'Editar','href':url_for('atendido.editar_unificado', id_atendido=row.id),'visible': current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.PROFESSOR.value, UserRole.COLAB_PROJETO.value, UserRole.ESTAGIARIO_DIREITO.value],'variant':'btn-primary'},
  {'label':'Tornar Assistido','href':url_for('atendido.tornar_assistido', id_atendido=row.id),'visible': (not row.assistido) and (current_user.urole == 'admin' or current_user.urole == 'estag_direito'),'variant':'btn-primary'},
  {'label':'Excluir','href':url_for('atendido.excluir_atendido'), 'method':'POST','csrf': csrf_token(), 'hidden': {'id': row.id}, 'confirm':'Você deseja excluir este atendido/assistido?','visible': current_user.urole == 'admin','variant':'btn-danger'}
]) }}
{% endmacro %}
{% set columns = [
  {'title':'Nome','key':'nome'},
  {'title':'CPF','renderer': cpf_label},
  {'title':'CNPJ','renderer': cnpj_label},
  {'title':'Telefone','renderer': telefone_label},
  {'title':'Ações','is_actions': true, 'renderer': actions_cell}
] %}
{% call(list_slot) listui.listing_layout(url_for('atendido.listagem_atendidos'), total=data.total if data else 0) %}
  {% if list_slot == 'filters' %}
    <div class="search-field">
      <label>Buscar:</label>
      <input type="text" name="valor_busca" value="{{ valor_busca }}" placeholder="Nome, CPF, CNPJ...">
    </div>
    <div class="search-field">
      <select name="tipo_busca">
        <option value="todos" {% if tipo_busca == 'todos' %}selected{% endif %}>Todos</option>
        <option value="atendidos" {% if tipo_busca == 'atendidos' %}selected{% endif %}>Atendidos</option>
        <option value="assistidos" {% if tipo_busca == 'assistidos' %}selected{% endif %}>Assistidos</option>
      </select>
    </div>
  {% elif list_slot == 'header_actions' %}
    <a class="btn btn-primary" href="{{ url_for('atendido.cadastrar_atendido') }}">Cadastrar Atendido</a>
  {% elif list_slot == 'content' %}
    {% if data and data.total > 0 %}
      {{ listui.table(columns, data.items) }}
      {{ listui.pagination(data, page_link) }}
    {% else %}
      {{ listui.empty_state('Nenhum atendido encontrado', valor_busca and ('Não foram encontrados resultados para "' ~ valor_busca ~ '"') or 'Não há atendidos cadastrados no momento', url_for('atendido.cadastrar_atendido'), 'Cadastrar novo atendido') }}
    {% endif %}
  {% endif %}
{% endcall %}
{% endblock conteudo %}

{% block scripts %}
<style>
.search-field select[name="tipo_busca"] {
  min-width: auto;
  width: auto;
}
</style>
<script src="{{url_for('static',filename='js/form_utilities.js')}}"></script>
<script>
FormUtils.setupAutoSubmit('select[name="tipo_busca"]');
</script>
{% endblock %}
