{% extends "base_dashboard.html" %}

{% block titulo %}Gestão de Usuários{% endblock %}

{% block conteudo %}
<nav class="d-inline-block">
  <ul class="pagination mb-0"></ul>
</nav>

<div class="card">
  <div class="card-body">
    <div class="card-title">
      <div class="d-flex flex-row">
        <div class="d-flex justify-content-start">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="search border p-1 rounded me-3">
            <i class="fas fa-search"></i>
            <input type="text" class="border-0" style="outline: 0;" id="searchUser" placeholder="Buscar usuário..." />
            <button type="button" id="clearSearch" class="btn btn-sm btn-outline-secondary ms-2 d-none" title="Limpar busca">
              <i class="fas fa-times"></i>
            </button>
            <div id="searchLoading" class="d-none">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
          </div>
          <div class="ml-3">
            <select class="form-control" id="urole" name="urole">
              <option value="all" selected>Todos</option>
              <option value="admin">Administrador</option>
              <option value="orient">Orientador</option>
              <option value="colab_proj">Colaborador de projeto</option>
              <option value="estag_direito">Estagiário de Direito</option>
              <option value="colab_ext">Colaborador externo</option>
              <option value="prof">Professor</option>
            </select>
          </div>
          <div class="ml-3">
            <select id="desativados" class="form-control">
              <option selected value="ativos">Ativos</option>
              <option value="inativos">Inativos</option>
            </select>
          </div>
          <div class="ml-3 d-flex align-items-center">
            <span class="me-2">Total:</span>
            <span class="badge badge-primary count-users">0</span>
          </div>
        </div>
        
        <div class="d-flex ml-auto">
          {% if current_user.urole in [usuario_urole_roles['ADMINISTRADOR'][0], usuario_urole_roles['PROFESSOR'][0]] %}
          <a class="btn btn-primary ml-auto p-2 px-2" href="{{url_for('usuario.cadastrar_usuario')}}">
            Cadastrar Usuário
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="container table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th class="bg-white">Nome</th>
            <th class="bg-white">E-mail</th>
            <th class="bg-white">Função</th>
            <th class="bg-white">Status</th>
            <th class="bg-white">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for usuario in usuarios.items %}
          <tr>
            <td>{{usuario.nome}}</td>
            <td>{{usuario.email}}</td>
            {% for key in usuario_urole_roles %}
            {% if usuario_urole_roles[key][0] == usuario.urole %}
            <td><span>{{usuario_urole_roles[key][1]}}</span></td>
            {% endif %}
            {% endfor %}
            <td>
              {% if usuario.status %}
                <span class="badge badge-success">Ativo</span>
              {% else %}
                <span class="badge badge-danger">Inativo</span>
              {% endif %}
            </td>
            <td>
              <div class="row">
                <button type="submit" class="btn mx-0 btn-flat btn-outline-primary btn-sm" name="button"><a
                    href="{{url_for('usuario.perfil_usuario', id_user = usuario.id)}}"
                    style="text-decoration: none; color: inherit;">Visualizar!! <i
                      class="fas fa-external-link-alt"></i></a></button>
                {% if current_user.urole in
                [usuario_urole_roles['ADMINISTRADOR'][0],usuario_urole_roles['PROFESSOR'][0]] and (usuario.id !=
                admin_padrao or current_user.id == admin_padrao)%}
                <button type="submit" class="btn mx-0 btn-flat btn-primary btn-sm" name="button"><a
                    href="{{url_for('usuario.editar_usuario', id_user = usuario.id)}}"
                    style="text-decoration: none;color: white;">Editar</a></button>
                {% endif %}
                {% if current_user.urole == usuario_urole_roles['ADMINISTRADOR'][0] and usuario.id != admin_padrao %}
                <form action="{{url_for('usuario.muda_senha_admin')}}" method="POST">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div>
                    <input type="hidden" name="id" value="{{usuario.id}}">
                  </div>
                  <button type="submit" class="btn mx-0 btn-flat btn-warning btn-sm"
                    onclick="return confirm('Você deseja realmente trocar a senha deste usuário?');">Mudar
                    Senha</button>
                </form>
                {% endif %}
                {% if current_user.urole == usuario_urole_roles['ADMINISTRADOR'][0] and usuario.id != admin_padrao %}
                <form action="{{url_for('usuario.inativar_usuario_lista')}}" method="POST">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div>
                    <input type="hidden" name="id" value="{{usuario.id}}">
                  </div>
                  <button type="submit" class="btn mx-0 btn-flat btn-outline-danger btn-sm"
                    onclick="return confirm('Você deseja realmente inativar este usuário?');"><i
                      class="fas fa-trash"></i></button>
                </form>
                {% endif %}

              </div>
            </td>
          </tr>

          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<style>
  .search {
    position: relative;
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #ddd !important;
    transition: border-color 0.3s ease;
  }
  
  .search:focus-within {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  
  .search input {
    flex: 1;
    padding: 0.375rem 0.75rem;
    border: none;
    background: transparent;
  }
  
  .search input:focus {
    outline: none;
    box-shadow: none;
  }
  
  .search i.fa-search {
    color: #6c757d;
    margin-right: 0.5rem;
  }
  
  #searchLoading {
    margin-left: 0.5rem;
    color: #007bff;
  }
  
  #clearSearch {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.25rem;
  }
  
  .table tbody tr td {
    vertical-align: middle;
  }
  
  .pagination .page-link {
    cursor: pointer;
  }
  
  .pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
  }
  
  .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
  }
  
  .badge-success {
    background-color: #28a745;
    color: white;
  }
  
  .badge-danger {
    background-color: #dc3545;
    color: white;
  }
</style>

<script defer>
  const users = [];
  const roles = {
    admin: "Administrador",
    orient: "Orientador",
    colab_proj: "Colaborador de projeto",
    estag_direito: "Estagiário de Direito",
    colab_ext: "Colaborador externo",
    prof: "Professor",
  }
  
  function getCSRFToken() {
    return document.querySelector('input[name="csrf_token"]').value;
  }
  
  async function refreshCSRFToken() {
    try {
      const response = await fetch('/usuario/listar_usuarios', {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newToken = doc.querySelector('input[name="csrf_token"]').value;
      document.querySelector('input[name="csrf_token"]').value = newToken;
      return newToken;
    } catch (error) {
      console.error('Error refreshing CSRF token:', error);
      window.location.reload();
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('submit', async function(e) {
      if (e.target.method === 'POST') {
        e.preventDefault();
        
        try {
          const formData = new FormData(e.target);
          const response = await fetch(e.target.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          
          if (response.status === 400) {
            const text = await response.text();
            if (text.includes('CSRF token has expired') || text.includes('CSRF token missing')) {
              await refreshCSRFToken();
              e.target.querySelector('input[name="csrf_token"]').value = getCSRFToken();
              e.target.submit();
              return;
            }
          }
          
          if (response.redirected) {
            window.location.href = response.url;
          } else if (response.ok) {
            window.location.reload();
          }
        } catch (error) {
          console.error('Form submission error:', error);
          e.target.submit();
        }
      }
    });
  });
  
  function actPagination() {
    document.querySelectorAll(".pagination li").forEach(item => {
      item.addEventListener("click", () => {
        document.querySelector(".pagination .active").classList.remove('active');
        sessionStorage.setItem("page-active", item.textContent)
        item.classList.add("active");
        let tbody = document.querySelector(".table tbody");
        tbody.innerHTML = "";
        
        if (users.length > 0) {
          // Sort users alphabetically by name
          const sortedUsers = [...users].sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
          let usersTable = paginator(sortedUsers, item.textContent, 20);
          usersTable.forEach(tableItem => {
            if (tableItem && tableItem.nome && tableItem.email && tableItem.urole && tableItem.id) {
              const statusBadge = tableItem.status ? 
                '<span class="badge badge-success">Ativo</span>' : 
                '<span class="badge badge-danger">Inativo</span>';
              
              tbody.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${tableItem.nome}</td>
                  <td>${tableItem.email}</td>
                  <td><span>${roles[tableItem.urole] || 'N/A'}</span></td>
                  <td>${statusBadge}</td>
                  <td>
                    <div class="row justify-content-end" style="gap: 0.2rem;">
                      <button type="submit" class="btn ml-2 mr-2 btn-flat btn-outline-primary btn-sm" name="button"><a href="/usuario/perfil/${tableItem.id}" style="text-decoration: none; color: inherit;">Visualizar <i class="fas fa-external-link-alt"></i></a></button>
                      
                      <button type="submit" class="btn mx-0 btn-flat btn-primary btn-sm" name="button"><a href="/usuario/editar_usuario/${tableItem.id}" style="text-decoration: none;color: white;">Editar</a></button>
                      
                      
                      <form action="/usuario/muda_senha_admin" method="POST">
                        <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                        <div>
                          <input type="hidden" name="id" value="${tableItem.id}">
                        </div>
                        <button type="submit" class="btn ml-1 btn-flat btn-warning btn-sm" onclick="return confirm('Você deseja realmente trocar a senha deste usuário?');">Mudar
                          Senha</button>
                      </form>
                      
                      
                      <form action="/usuario/inativar_usuario_lista/" method="POST">
                        <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                        <div>
                          <input type="hidden" name="id" value="${tableItem.id}">
                        </div>
                        <button type="submit" class="btn ml-1 btn-flat btn-outline-danger btn-sm" onclick="return confirm('Você deseja realmente inativar este usuário?');"><i class="fas fa-trash"></i></button>
                      </form>                
                    </div>
                  </td>
                </tr>`
              );
            } else {
              console.warn("Skipping invalid user item in pagination:", tableItem);
            }
          });
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">
                <i class="fas fa-users"></i> Nenhum usuário encontrado
              </td>
            </tr>
          `;
        }
      })
    })
  }
  async function getUsers() {
    try {
      const url = `/usuario/busca_usuarios?funcao=all&status=1`;
      const data = await fetch(url, {
        method: "GET",
        headers: {
          'X-CSRF-Token': getCSRFToken()
        }
      });
      
      if (!data.ok) {
        throw new Error(`HTTP error! status: ${data.status}`);
      }
      
      const responseText = await data.text();
      let res;
      try {
        res = JSON.parse(responseText);
      } catch (parseError) {
        throw new Error("Invalid JSON response from server");
      }
      
      if (res && res.users && Array.isArray(res.users)) {
        users.length = 0;
        res.users.forEach(item => {
          if (item && item.nome && item.email && item.urole && item.id) {
            users.push(item);
          }
        });
      } else {
        users.length = 0;
        res = { users: [] };
      }
      
      return res;
    } catch (error) {
      users.length = 0;
      return { users: [] };
    }
  }
  async function getUsersByFilter(){
    try {
      const funcao = document.querySelector("#urole").value;
      const status = document.querySelector("#desativados").value === "ativos" ? 1 : 0;
      const searchTerm = document.querySelector("#searchUser").value;
      
      let url = `/usuario/busca_usuarios?funcao=${funcao}&status=${status}`;
      if (searchTerm) {
        url += `&valor_busca=${encodeURIComponent(searchTerm)}`;
      }
      
      const res = await fetch(url);
      
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      
      const responseText = await res.text();
      let data;
      try {
        data = JSON.parse(responseText);
      } catch (parseError) {
        throw new Error("Invalid JSON response from server");
      }
      
      users.length = 0;
      
      if (data && data.users && Array.isArray(data.users)) {
        data.users.forEach(item => {
          if (item && item.nome && item.email && item.urole && item.id) {
            users.push(item);
          }
        });
      } else {
        users.length = 0;
      }
      
      let totalPage = Math.ceil(users.length / 20);

      let pagination = document.querySelector(".pagination");
      pagination.innerHTML = "";
      sessionStorage.setItem("page-active", 1);
      document.querySelector(".count-users").textContent = users.length;
      let active = sessionStorage.getItem("page-active");
      
      for (let i = 1; i <= totalPage; i++) {
        pagination.insertAdjacentHTML('beforeend', `<li class="page-item ${active == i ? "active" : ""}"><a class="page-link" href="#">${i}</a></li>`);
        actPagination();
      }
      
      let tbody = document.querySelector(".table tbody");
      tbody.innerHTML = "";
      
      if (users.length > 0) {
        // Sort users alphabetically by name
        const sortedUsers = [...users].sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
        let usersTable = paginator(sortedUsers, active, 20);
        usersTable.forEach(item => {
          if (item && item.nome && item.email && item.urole && item.id) {
            const statusBadge = item.status ? 
              '<span class="badge badge-success">Ativo</span>' : 
              '<span class="badge badge-danger">Inativo</span>';
            
            tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${item.nome}</td>
              <td>${item.email}</td>
              <td><span>${roles[item.urole] || 'N/A'}</span></td>
              <td>${statusBadge}</td>
              <td>
                <div class="row justify-content-end" style="gap: 0.2rem">
                  <button type="submit" class="btn mx-0 btn-flat btn-outline-primary btn-sm" name="button"><a href="/usuario/perfil/${item.id}" style="text-decoration: none; color: inherit;">Visualizar <i class="fas fa-external-link-alt"></i></a></button>
                  
                  <button type="submit" class="btn mx-0 btn-flat btn-primary btn-sm" name="button"><a href="/usuario/editar_usuario/${item.id}" style="text-decoration: none;color: white;">Editar</a></button>
                  
                  
                  <form action="/usuario/muda_senha_admin" method="POST">
                    <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                    <div>
                      <input type="hidden" name="id" value="${item.id}">
                    </div>
                    <button type="submit" class="btn mx-0 btn-flat btn-warning btn-sm" onclick="return confirm('Você deseja realmente trocar a senha deste usuário?');">Mudar
                      Senha</button>
                  </form>
                  
                  
                  <form action="/usuario/inativar_usuario_lista/" method="POST">
                    <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                    <div>
                      <input type="hidden" name="id" value="${item.id}">
                    </div>
                    <button type="submit" class="btn mx-0 btn-flat btn-outline-danger btn-sm" onclick="return confirm('Você deseja realmente inativar este usuário?');"><i class="fas fa-trash"></i></button>
                  </form>                
                </div>
              </td>
            </tr>`
            );
          }
        });
      } else {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              <div>
                <i class="fas fa-search fa-2x mb-2"></i>
                <p class="mb-1">Nenhum usuário encontrado</p>
                <small class="text-muted">Tente usar termos diferentes ou verificar a ortografia</small>
              </div>
            </td>
          </tr>
        `;
      }
    } catch (error) {
      console.error('Error in getUsersByFilter:', error);
      users.length = 0;
      document.querySelector(".count-users").textContent = "0";
      document.querySelector(".pagination").innerHTML = "";
      document.querySelector(".table tbody").innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-danger">
            <i class="fas fa-exclamation-triangle"></i> Erro ao buscar usuários
          </td>
        </tr>
      `;
    }
  }
  const paginator = (items, pageActual, limitItems) => {
    let result = [];
    let totalPage = Math.ceil(items.length / limitItems);
    let count = (pageActual * limitItems) - limitItems;
    let delimiter = count + limitItems;

    if (pageActual <= totalPage) {
      for (let i = count; i < delimiter; i++) {
        result.push(items[i]);
        count++;
      }
    }
    return result;
  }

  async function mountTable() {
    try {
      const res = await getUsers();
      
      if (res && res.users && Array.isArray(res.users)) {
        let totalPage = Math.ceil(res.users.length / 20);

        let pagination = document.querySelector(".pagination");
        pagination.innerHTML = "";
        sessionStorage.setItem("page-active", 1);
        document.querySelector(".count-users").textContent = res.users.length;
        let active = sessionStorage.getItem("page-active");
        
        for (let i = 1; i <= totalPage; i++) {
          pagination.insertAdjacentHTML('beforeend', `<li class="page-item ${active == i ? "active" : ""}"><a class="page-link" href="#">${i}</a></li>`);
          actPagination();
        }
        
        let tbody = document.querySelector(".table tbody");
        tbody.innerHTML = "";
        
        if (res.users.length > 0) {
          // Sort users alphabetically by name
          const sortedUsers = [...res.users].sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
          let usersTable = paginator(sortedUsers, active, 20);
          usersTable.forEach(item => {
            if (item && item.nome && item.email && item.urole && item.id) {
              const statusBadge = item.status ? 
                '<span class="badge badge-success">Ativo</span>' : 
                '<span class="badge badge-danger">Inativo</span>';
              
              tbody.insertAdjacentHTML("beforeend", `
              <tr>
                <td>${item.nome}</td>
                <td>${item.email}</td>
                <td><span>${roles[item.urole] || 'N/A'}</span></td>
                <td>${statusBadge}</td>
                <td>
                  <div class="row justify-content-end" style="gap: 0.2rem">
                    <button type="submit" class="btn mx-0 btn-flat btn-outline-primary btn-sm" name="button"><a href="/usuario/perfil/${item.id}" style="text-decoration: none; color: inherit;">Visualizar <i class="fas fa-external-link-alt"></i></a></button>
                    
                    <button type="submit" class="btn mx-0 btn-flat btn-primary btn-sm" name="button"><a href="/usuario/editar_usuario/${item.id}" style="text-decoration: none;color: white;">Editar</a></button>
                    
                    
                    <form action="/usuario/muda_senha_admin" method="POST">
                      <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                      <div>
                        <input type="hidden" name="id" value="${item.id}">
                      </div>
                      <button type="submit" class="btn mx-0 btn-flat btn-warning btn-sm" onclick="return confirm('Você deseja realmente trocar a senha deste usuário?');">Mudar
                        Senha</button>
                    </form>
                    
                    
                    <form action="/usuario/inativar_usuario_lista/" method="POST">
                      <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                      <div>
                        <input type="hidden" name="id" value="${item.id}">
                      </div>
                      <button type="submit" class="btn mx-0 btn-flat btn-outline-danger btn-sm" onclick="return confirm('Você deseja realmente inativar este usuário?');"><i class="fas fa-trash"></i></button>
                    </form>                
                  </div>
                </td>
              </tr>`
              );
            }
          });
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                <div>
                  <i class="fas fa-users fa-2x mb-2"></i>
                  <p class="mb-1">Nenhum usuário cadastrado</p>
                  <small class="text-muted">Não há usuários no sistema ou todos estão inativos</small>
                </div>
              </td>
            </tr>
          `;
        }
      } else {
        document.querySelector(".count-users").textContent = "0";
        document.querySelector(".pagination").innerHTML = "";
        document.querySelector(".table tbody").innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              <div>
                <i class="fas fa-users fa-2x mb-2"></i>
                <p class="mb-1">Nenhum usuário cadastrado</p>
                <small class="text-muted">Não há usuários no sistema ou todos estão inativos</small>
              </div>
            </td>
          </tr>
        `;
      }
    } catch (error) {
      document.querySelector(".count-users").textContent = "0";
      document.querySelector(".pagination").innerHTML = "";
      document.querySelector(".table tbody").innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-danger">
            <i class="fas fa-exclamation-triangle"></i> Erro ao carregar usuários
          </td>
        </tr>
      `;
    }
  }
  window.onload = async () => {
    mountTable();
    const userLength = document.querySelectorAll(".table tbody tr").length;
    const usersTable = document.querySelectorAll(".table tbody tr");




    const searchInput = document.querySelector("#searchUser");
    const clearSearchButton = document.querySelector("#clearSearch");
    let searchTimeout;
    searchInput.addEventListener("input", async (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        try {
          const searchTerm = e.target.value.trim();
          
          if (searchTerm.length === 0) {
            await getUsers();
            await mountTable();
            clearSearchButton.classList.add('d-none');
            return;
          }
          
          document.querySelector("#searchLoading").classList.remove("d-none");
          await getUsersByFilter();
          document.querySelector(".count-users").textContent = users.length;
          clearSearchButton.classList.remove('d-none');
        } catch (error) {
          console.error('Error during search:', error);
        } finally {
          document.querySelector("#searchLoading").classList.add("d-none");
        }
      }, 300);
    });

    clearSearchButton.addEventListener("click", async () => {
      searchInput.value = "";
      await getUsers();
      await mountTable();
      clearSearchButton.classList.add('d-none');
      document.querySelector(".count-users").textContent = users.length;
    });
    

    const status = document.querySelector("#desativados");
    status.onchange = async (e) => {
      await getUsersByFilter();
      document.querySelector(".count-users").textContent = users.length;
    }

    const urole = document.querySelector("#urole");
    urole.onchange = async (e) => {
      await getUsersByFilter();
      document.querySelector(".count-users").textContent = users.length;
    }
  };
</script>

{% endblock %}