{% extends "base_dashboard.html" %}

{% block titulo %}Gestão de Usuários{% endblock %}

{% block conteudo %}
<div class="card">
  <div class="card-body">
    <div class="card-title">
      <div class="d-flex flex-row">
        <div class="d-flex justify-content-start">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="search border p-1 rounded me-3">
            <i class="fas fa-search"></i>
            <input type="text" class="border-0" style="outline: 0;" id="searchUser" placeholder="Buscar usuário..." />
            <button type="button" id="clearSearch" class="btn btn-sm btn-outline-secondary ms-2 d-none" title="Limpar busca">
              <i class="fas fa-times"></i>
            </button>
            <div id="searchLoading" class="d-none">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
          </div>
          <div class="ml-3">
            <select class="form-control" id="urole" name="urole">
              <option value="all" selected>Todos</option>
              <option value="admin">Administrador</option>
              <option value="orient">Orientador</option>
              <option value="colab_proj">Colaborador de projeto</option>
              <option value="estag_direito">Estagiário de Direito</option>
              <option value="colab_ext">Colaborador externo</option>
              <option value="prof">Professor</option>
            </select>
          </div>
          <div class="ml-3">
            <select id="desativados" class="form-control">
              <option selected value="ativos">Ativos</option>
              <option value="inativos">Inativos</option>
            </select>
          </div>
          <div class="ml-3 d-flex align-items-center">
            <span class="me-2">Total:</span>
            <span class="badge badge-primary">{{ usuarios.total }}</span>
          </div>
        </div>
        
        <div class="d-flex ml-auto">
          {% if current_user.urole in [UserRole.ADMINISTRADOR.value, UserRole.PROFESSOR.value] %}
          <a class="btn btn-primary ml-auto p-2 px-2" href="{{url_for('usuario.cadastrar_usuario')}}">
            Cadastrar Usuário
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="container table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th class="bg-white">Nome</th>
            <th class="bg-white">E-mail</th>
            <th class="bg-white">Função</th>
            <th class="bg-white">Status</th>
            <th class="bg-white text-right">Ações</th>
          </tr>
        </thead>
        <tbody id="users-table-body">
          {% include 'usuario/partials/usuarios_table_rows.html' %}
        </tbody>
      </table>
    </div>
    
    <div id="pagination-container">
      {% if usuarios.pages > 1 %}
        {% include 'usuario/partials/usuarios_pagination.html' %}
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  .search {
    position: relative;
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #ddd !important;
    transition: border-color 0.3s ease;
  }
  
  .search:focus-within {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  
  .search input {
    flex: 1;
    padding: 0.375rem 0.75rem;
    border: none;
    background: transparent;
  }
  
  .search input:focus {
    outline: none;
    box-shadow: none;
  }
  
  .search i.fa-search {
    color: #6c757d;
    margin-right: 0.5rem;
  }
  
  #searchLoading {
    margin-left: 0.5rem;
    color: #007bff;
  }
  
  #clearSearch {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.25rem;
  }
  
  .table tbody tr td {
    vertical-align: middle;
  }
  
  .pagination .page-link {
    cursor: pointer;
  }
  
  .pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
  }
  
  .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
  }
  
  .badge-success {
    background-color: #28a745;
    color: white;
  }
  
  .badge-danger {
    background-color: #dc3545;
    color: white;
  }
  
  /* Action buttons - icon only */
  .table td .btn-sm {
    padding: 0.375rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
  }
  
  .table td .btn-sm i {
    font-size: 0.875rem;
  }
  
  .table td .d-flex {
    gap: 0.25rem;
  }
  
  /* Actions column alignment */
  .table th.text-right,
  .table td.text-right {
    text-align: right !important;
  }
  
  .table td.text-right .d-flex {
    justify-content: flex-end;
  }
  
  /* Loading state */
  #users-table-body {
    transition: opacity 0.3s ease;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector("#searchUser");
    const clearSearchButton = document.querySelector("#clearSearch");
    const searchLoadingIndicator = document.querySelector("#searchLoading");
    const uroleSelect = document.querySelector("#urole");
    const statusSelect = document.querySelector("#desativados");
    const usersTableBody = document.querySelector("#users-table-body");
    const paginationContainer = document.querySelector("#pagination-container");
    const totalBadge = document.querySelector(".badge-primary");
    
    let searchTimeout;
    let lastSearchTerm = '';
    let lastFuncao = 'all';
    let lastStatus = '1';
    let currentPage = 1;
    const DEBOUNCE_DELAY = 300;
    const MIN_SEARCH_LENGTH = 2;

    function showLoading() {
        if (searchLoadingIndicator) {
            searchLoadingIndicator.classList.remove('d-none');
        }
        if (usersTableBody) {
            usersTableBody.style.opacity = '0.6';
        }
    }

    function hideLoading() {
        if (searchLoadingIndicator) {
            searchLoadingIndicator.classList.add('d-none');
        }
        if (usersTableBody) {
            usersTableBody.style.opacity = '1';
        }
    }

    function updateClearButton() {
        const hasValue = searchInput.value.trim().length > 0;
        if (clearSearchButton) {
            clearSearchButton.classList.toggle('d-none', !hasValue);
        }
    }

    function updateFilters(page = 1, immediate = false) {
        const searchTerm = searchInput.value.trim();
        const funcao = uroleSelect.value;
        const status = statusSelect.value === "ativos" ? "1" : "0";
        
        if (searchTerm.length > 0 && searchTerm.length < MIN_SEARCH_LENGTH && !immediate) {
            hideLoading();
            return;
        }

        if (searchTerm === lastSearchTerm && funcao === lastFuncao && 
            status === lastStatus && page === currentPage && !immediate) {
            hideLoading();
            return;
        }

        lastSearchTerm = searchTerm;
        lastFuncao = funcao;
        lastStatus = status;
        currentPage = page;

        showLoading();

        const params = new URLSearchParams();
        if (searchTerm && searchTerm.length >= MIN_SEARCH_LENGTH) {
            params.set('search', searchTerm);
        }
        if (funcao && funcao !== 'all') {
            params.set('funcao', funcao);
        }
        if (status !== "1") {
            params.set('status', status);
        }
        if (page > 1) {
            params.set('page', page);
        }

        const ajaxUrl = '/usuario/busca_usuarios_ajax?' + params.toString();

        fetch(ajaxUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                usersTableBody.innerHTML = data.table_html;
                paginationContainer.innerHTML = data.pagination_html;
                
                if (totalBadge) {
                    totalBadge.textContent = data.total;
                }
                
                attachPaginationListeners();
                updateBrowserURL(searchTerm, funcao, status, page);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            window.location.reload();
        })
        .finally(() => {
            hideLoading();
        });
    }

    function updateBrowserURL(searchTerm, funcao, status, page) {
        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        url.searchParams.delete('funcao');
        url.searchParams.delete('status');
        url.searchParams.delete('page');
        
        if (searchTerm && searchTerm.length >= MIN_SEARCH_LENGTH) {
            url.searchParams.set('search', searchTerm);
        }
        if (funcao && funcao !== 'all') {
            url.searchParams.set('funcao', funcao);
        }
        if (status !== "1") {
            url.searchParams.set('status', status);
        }
        if (page > 1) {
            url.searchParams.set('page', page);
        }
        
        window.history.replaceState({}, '', url);
    }

    function attachPaginationListeners() {
        const paginationLinks = document.querySelectorAll('.pagination-link');
        paginationLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page) {
                    updateFilters(page, true);
                }
            });
        });
    }

    function debouncedSearch() {
        clearTimeout(searchTimeout);
        updateClearButton();
        
        searchTimeout = setTimeout(() => {
            updateFilters(1);
        }, DEBOUNCE_DELAY);
    }

    searchInput.addEventListener("input", debouncedSearch);

    searchInput.addEventListener("paste", () => {
        setTimeout(() => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => updateFilters(1), 100);
        }, 10);
    });

    clearSearchButton.addEventListener("click", () => {
        searchInput.value = "";
        lastSearchTerm = '';
        hideLoading();
        updateClearButton();
        
        uroleSelect.value = 'all';
        statusSelect.value = 'ativos';
        
        updateFilters(1, true);
    });

    searchInput.addEventListener("keydown", (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(searchTimeout);
            updateFilters(1, true);
        }
        
        if (e.key === 'Escape') {
            searchInput.value = "";
            lastSearchTerm = '';
            hideLoading();
            updateClearButton();
            
            uroleSelect.value = 'all';
            statusSelect.value = 'ativos';
            
            updateFilters(1, true);
        }
    });

    uroleSelect.addEventListener("change", () => updateFilters(1, true));
    statusSelect.addEventListener("change", () => updateFilters(1, true));

    updateClearButton();
    attachPaginationListeners();
});
</script>
{% endblock %}
