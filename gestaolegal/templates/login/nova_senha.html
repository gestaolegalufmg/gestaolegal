{% extends "login/base_login.html" %}

{% block title %}Nova Senha{% endblock %}
{% block page_title %}Nova Senha{% endblock %}

{% block form_content %}
<form method="POST" action="{{url_for('usuario.confirma_senha')}}" class="needs-validation" novalidate="" role="form" aria-labelledby="new-password-title">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="id_usuario" value="{{id_usuario}}">
  
  <fieldset>
    <legend class="sr-only">Informações da nova senha</legend>
    
    <div class="form-group">
      <label for="senha" id="password-label">Nova senha</label>
      <input 
        id="senha" 
        name="senha" 
        type="password" 
        class="form-control" 
        required 
        autocomplete="new-password"
        aria-labelledby="password-label"
        aria-describedby="password-error password-strength"
        aria-invalid="false"
        autofocus>
      <div id="password-error" class="invalid-feedback" role="alert" aria-live="polite">
        Por favor informe uma nova senha
      </div>
      <div id="password-strength" class="password-strength" aria-live="polite"></div>
    </div>
    
    <div class="form-group">
      <label for="confirmar_senha" id="confirm-password-label">Confirme sua senha</label>
      <input 
        id="confirmar_senha" 
        name="confirmar_senha" 
        type="password" 
        class="form-control" 
        required 
        autocomplete="new-password"
        aria-labelledby="confirm-password-label"
        aria-describedby="confirm-password-error"
        aria-invalid="false">
      <div id="confirm-password-error" class="invalid-feedback" role="alert" aria-live="polite">
        Por favor repita a senha
      </div>
    </div>
  </fieldset>
  
  <div class="form-group">
    <button 
      type="submit" 
      class="btn btn-primary btn-lg btn-block" 
      id="submit"
      aria-describedby="submit-description">
      <span class="btn-text">Alterar senha</span>
      <span class="sr-only" id="submit-description">Pressione Enter para alterar a senha</span>
    </button>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector("form");
    const passwordInput = document.getElementById('senha');
    const confirmPasswordInput = document.getElementById('confirmar_senha');
    const submitButton = document.getElementById('submit');
    const btnText = submitButton.querySelector('.btn-text');
    const passwordStrength = document.getElementById('password-strength');
    
    const setLoading = (isLoading) => {
      if (isLoading) {
        submitButton.disabled = true;
        btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Alterando...';
      } else {
        submitButton.disabled = false;
        btnText.textContent = 'Alterar senha';
      }
    };

    const checkPasswordStrength = (password) => {
      if (!password) {
        passwordStrength.textContent = '';
        return;
      }

      let strength = 0;
      let feedback = [];

      if (password.length >= 8) strength++;
      else feedback.push('mínimo 8 caracteres');

      if (/[a-z]/.test(password)) strength++;
      else feedback.push('letras minúsculas');

      if (/[A-Z]/.test(password)) strength++;
      else feedback.push('letras maiúsculas');

      if (/[0-9]/.test(password)) strength++;
      else feedback.push('números');

      if (/[^A-Za-z0-9]/.test(password)) strength++;
      else feedback.push('símbolos especiais');

      if (strength < 3) {
        passwordStrength.textContent = `Senha fraca. Adicione: ${feedback.slice(0, 2).join(', ')}`;
        passwordStrength.className = 'password-strength weak';
      } else if (strength < 4) {
        passwordStrength.textContent = 'Senha média. Considere adicionar mais caracteres especiais.';
        passwordStrength.className = 'password-strength medium';
      } else {
        passwordStrength.textContent = 'Senha forte!';
        passwordStrength.className = 'password-strength strong';
      }
    };

    const validateForm = () => {
      let isValid = true;
      
      document.querySelectorAll('.alert-danger').forEach(alert => alert.remove());
      passwordInput.classList.remove('is-invalid');
      confirmPasswordInput.classList.remove('is-invalid');
      
      if (!passwordInput.value.trim()) {
        passwordInput.classList.add('is-invalid');
        isValid = false;
      } else if (passwordInput.value.length < 8) {
        passwordInput.classList.add('is-invalid');
        passwordInput.parentElement.insertAdjacentHTML('afterend', 
          '<div class="alert alert-danger mt-2">A senha deve ter pelo menos 8 caracteres</div>');
        isValid = false;
      }
      
      if (!confirmPasswordInput.value.trim()) {
        confirmPasswordInput.classList.add('is-invalid');
        isValid = false;
      } else if (passwordInput.value !== confirmPasswordInput.value) {
        confirmPasswordInput.classList.add('is-invalid');
        confirmPasswordInput.parentElement.insertAdjacentHTML('afterend', 
          '<div class="alert alert-danger mt-2">As senhas não coincidem</div>');
        isValid = false;
      }
      
      return isValid;
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!validateForm()) {
        return;
      }
      
      setLoading(true);
      
      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          window.location.href = "{{url_for('usuario.login')}}";
        } else {
          const errorText = await response.text();
          passwordInput.parentElement.insertAdjacentHTML('afterend', 
            '<div class="alert alert-danger mt-2">Erro ao alterar senha. Tente novamente.</div>');
        }
      } catch (error) {
        console.error('Error:', error);
        passwordInput.parentElement.insertAdjacentHTML('afterend', 
          '<div class="alert alert-danger mt-2">Erro ao processar solicitação. Tente novamente.</div>');
      } finally {
        setLoading(false);
      }
    });

    passwordInput.addEventListener('input', () => {
      checkPasswordStrength(passwordInput.value);
      if (passwordInput.classList.contains('is-invalid')) {
        validateForm();
      }
    });

    confirmPasswordInput.addEventListener('input', () => {
      if (confirmPasswordInput.classList.contains('is-invalid')) {
        validateForm();
      }
    });

    passwordInput.addEventListener('blur', validateForm);
    confirmPasswordInput.addEventListener('blur', validateForm);
  });
</script>
{% endblock %}
